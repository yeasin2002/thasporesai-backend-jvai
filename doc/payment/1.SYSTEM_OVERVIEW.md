# JobSphere Payment System - Complete Overview

**Version**: 2.0.0  
**Last Updated**: January 24, 2026  
**Status**: âœ… Production Ready

---

## ğŸ“‹ Quick Navigation

- **Backend Developers**: Start with [2.BACKEND_IMPLEMENTATION.md](./2.BACKEND_IMPLEMENTATION.md)
- **Frontend/Mobile Developers**: Start with [3.FRONTEND_API_GUIDE.md](./3.FRONTEND_API_GUIDE.md)
- **Stripe Integration**: See [4.STRIPE_INTEGRATION.md](./4.STRIPE_INTEGRATION.md)
- **Testing**: See [5.TESTING_GUIDE.md](./5.TESTING_GUIDE.md)
- **Deployment**: See [6.PRODUCTION_DEPLOYMENT.md](./6.PRODUCTION_DEPLOYMENT.md)

---

## ğŸ¯ System Overview

JobSphere is a wallet-based escrow payment system connecting customers with contractors through secure, commission-based transactions.

### Key Features

- âœ… **Wallet System**: Prepaid balance + escrow holding
- âœ… **Escrow Protection**: Money held safely until job completion
- âœ… **Automated Commissions**: 5% platform fee + 20% service fee
- âœ… **One Offer Per Job**: Simplified workflow
- âœ… **Automatic Refunds**: Full refund on rejection/cancellation
- âœ… **Offer Expiration**: Auto-expires after 7 days
- âœ… **Transaction History**: Complete audit trail
- âœ… **Real-time Notifications**: Socket.IO + FCM push notifications

---

## ğŸ’° Commission Structure

### Simple Breakdown

```
$100 Job Example:

Customer Pays: $105 (100 + 5%)
â”œâ”€ Platform Fee (5%): $5 â†’ Admin (when offer accepted)
â””â”€ Job Amount: $100 â†’ Escrow
   â”œâ”€ Service Fee (20%): $20 â†’ Admin (when job completed)
   â””â”€ Contractor Payout (80%): $80 â†’ Contractor (when job completed)

Admin Total: $25 (5% + 20%)
Contractor Gets: $80
```

### Commission Timing

| Fee               | Amount  | When Charged   | Recipient  |
| ----------------- | ------- | -------------- | ---------- |
| Platform Fee      | 5%      | Offer Accepted | Admin      |
| Service Fee       | 20%     | Job Completed  | Admin      |
| Contractor Payout | 80%     | Job Completed  | Contractor |
| **Admin Total**   | **25%** | **Combined**   | **Admin**  |

---

## ğŸ”„ Complete Money Flow

### Step-by-Step Journey

```
1. CUSTOMER DEPOSITS MONEY
   Customer â†’ Deposits $200 â†’ Wallet Balance: $200

2. CUSTOMER POSTS JOB
   Job created with $100 budget â†’ Status: "open"

3. CONTRACTOR APPLIES
   Application submitted â†’ Status: "pending"

4. CUSTOMER SENDS OFFER
   Offer: $100 job + $5 platform fee = $105 total
   Wallet: $200 - $105 = $95 available
   Escrow: $105 (locked)
   Offer Status: "pending"

5A. CONTRACTOR ACCEPTS âœ…
   Platform Fee: $5 â†’ Admin Wallet
   Escrow: $100 (remaining)
   Job Status: "assigned"
   Other applications: rejected

5B. CONTRACTOR REJECTS âŒ
   Full Refund: $105 â†’ Customer Wallet
   Wallet: $200 (restored)
   Application Status: "pending" (reset)

6. CONTRACTOR WORKS
   Job Status: "in_progress"

7. CUSTOMER MARKS COMPLETE
   Service Fee: $20 â†’ Admin Wallet
   Contractor Payout: $80 â†’ Contractor Wallet
   Escrow: $0 (released)
   Job Status: "completed"

8. CONTRACTOR WITHDRAWS
   Withdrawal: $50 â†’ Bank Account (2-3 days)
   Wallet: $30 (remaining)
```

---

## ğŸ—ï¸ System Architecture

### Core Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CUSTOMER (Buyer)                         â”‚
â”‚  â€¢ Posts jobs                                                â”‚
â”‚  â€¢ Deposits money to wallet                                 â”‚
â”‚  â€¢ Sends offers                                             â”‚
â”‚  â€¢ Marks jobs complete                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BACKEND SYSTEM                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Wallet Module                                        â”‚  â”‚
â”‚  â”‚  â€¢ Balance management                                 â”‚  â”‚
â”‚  â”‚  â€¢ Escrow holding                                     â”‚  â”‚
â”‚  â”‚  â€¢ Deposits & withdrawals                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Offer Module                                         â”‚  â”‚
â”‚  â”‚  â€¢ Offer creation (3 flows)                          â”‚  â”‚
â”‚  â”‚  â€¢ Accept/reject handling                            â”‚  â”‚
â”‚  â”‚  â€¢ Commission calculation                            â”‚  â”‚
â”‚  â”‚  â€¢ One offer per job enforcement                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Job Module                                           â”‚  â”‚
â”‚  â”‚  â€¢ Job lifecycle management                          â”‚  â”‚
â”‚  â”‚  â€¢ Status transitions                                â”‚  â”‚
â”‚  â”‚  â€¢ Payment release on completion                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Transaction Module                                   â”‚  â”‚
â”‚  â”‚  â€¢ Complete audit trail                              â”‚  â”‚
â”‚  â”‚  â€¢ 8 transaction types                               â”‚  â”‚
â”‚  â”‚  â€¢ Immutable records                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Admin Service                                        â”‚  â”‚
â”‚  â”‚  â€¢ Auto-creates admin user                           â”‚  â”‚
â”‚  â”‚  â€¢ Auto-creates admin wallet                         â”‚  â”‚
â”‚  â”‚  â€¢ Commission collection                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Automated Jobs                                       â”‚  â”‚
â”‚  â”‚  â€¢ Offer expiration (hourly)                         â”‚  â”‚
â”‚  â”‚  â€¢ Automatic refunds                                 â”‚  â”‚
â”‚  â”‚  â€¢ Notification dispatch                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CONTRACTOR (Seller)                         â”‚
â”‚  â€¢ Browses jobs                                             â”‚
â”‚  â€¢ Applies to jobs                                          â”‚
â”‚  â€¢ Accepts/rejects offers                                   â”‚
â”‚  â€¢ Completes work                                           â”‚
â”‚  â€¢ Withdraws earnings                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Database Models

### Core Models

**1. Wallet**

- Stores user balance (available + escrow)
- Tracks lifetime earnings/spending
- Supports freeze functionality

**2. Offer**

- One offer per job (enforced by unique index)
- Stores all commission amounts
- Tracks status and timestamps
- Auto-expires after 7 days

**3. Transaction**

- Immutable audit trail
- 8 transaction types
- Links to offers, jobs, users
- Complete money movement history

**4. Job** (Extended)

- Added payment fields
- Tracks contractor assignment
- Links to accepted offer
- Stores completion timestamps

---

## ğŸ” Security Features

### Authentication & Authorization

- JWT-based authentication
- Role-based access control (Customer/Contractor/Admin)
- Resource ownership validation
- Automatic role verification

### Transaction Security

- Atomic database operations (MongoDB transactions)
- Race condition prevention (optimistic locking)
- Balance verification before deduction
- Escrow protection (separate from available balance)
- Complete audit trail

### Wallet Security

- Freeze functionality (admin can freeze suspicious wallets)
- Withdrawal limits ($10 min, $10,000 max)
- Contractor-only withdrawals
- Balance validation on all operations

---

## ğŸ¯ Key Business Rules

### 1. One Offer Per Job

```typescript
// Enforced by unique index
offerSchema.index({ job: 1 }, { unique: true });
```

- Customer can only send ONE offer per job
- Must wait for rejection/expiration to send new offer
- Prevents confusion and duplicate payments

### 2. Wallet Balance Requirements

```typescript
// Customer must have sufficient balance
if (wallet.balance < totalCharge) {
  throw new Error("Insufficient balance");
}
```

- Customer must deposit money before sending offers
- Balance checked before every transaction
- Prevents overdrafts and negative balances

### 3. Escrow Management

```typescript
// Money locked in escrow until decision
wallet.balance -= totalCharge;
wallet.escrowBalance += totalCharge;
```

- Money moved to escrow when offer sent
- Released on acceptance/rejection/expiration
- Protects both parties

### 4. Status Transitions

```
Job: open â†’ assigned â†’ in_progress â†’ completed/cancelled
Offer: pending â†’ accepted/rejected/cancelled/expired
```

- Strict status flow enforcement
- Invalid transitions rejected
- Terminal states (completed/cancelled)

---

## ğŸ“± Integration Points

### Frontend/Mobile Apps

- REST API endpoints for all operations
- Real-time updates via Socket.IO
- Push notifications via FCM
- Complete transaction history

### Payment Gateway (Future)

- Stripe integration for deposits
- Stripe Connect for withdrawals
- Webhook handling for confirmations
- Automatic payment processing

### Notification System

- Socket.IO for real-time updates
- FCM for push notifications
- 10 notification types
- Multi-device support

---

## ğŸš€ Current Implementation Status

### âœ… Completed Features

**Core Payment System**

- [x] Wallet management (balance + escrow)
- [x] Offer creation (3 flows: application, invite, direct)
- [x] Offer acceptance/rejection
- [x] Job completion with payment release
- [x] Job cancellation with refunds
- [x] Transaction history
- [x] Withdrawal functionality

**Business Logic**

- [x] Commission calculation (5% + 20%)
- [x] Escrow hold/release
- [x] Platform fee transfer on acceptance
- [x] Service fee + payout on completion
- [x] Full refund on rejection
- [x] Automatic offer expiration (7 days)

**Security & Data Integrity**

- [x] MongoDB transactions (atomicity)
- [x] Race condition prevention
- [x] Balance validation
- [x] Authorization checks
- [x] Input validation (Zod schemas)

**Admin Features**

- [x] Auto-create admin user
- [x] Auto-create admin wallet
- [x] Commission collection
- [x] Transaction monitoring

**Notifications**

- [x] Real-time Socket.IO events
- [x] FCM push notifications
- [x] 10 notification types
- [x] Multi-device support

### âš ï¸ Pending Features (Optional)

**Stripe Integration** (Future Enhancement)

- [ ] Stripe Payment Intents for deposits
- [ ] Stripe Connect for withdrawals
- [ ] Webhook handling
- [ ] Payment confirmation

**Additional Features** (Future)

- [ ] Partial refunds
- [ ] Dispute resolution
- [ ] Multi-currency support
- [ ] Milestone payments

---

## ğŸ“ˆ System Metrics

### Performance

- Wallet operations: < 500ms
- Offer operations: < 1000ms
- Transaction queries: < 2000ms
- Job operations: < 1000ms

### Scalability

- Supports concurrent operations
- Atomic database transactions
- Optimistic locking for race conditions
- Indexed queries for performance

### Reliability

- Complete audit trail
- Automatic refunds on failures
- Offer expiration handling
- Error recovery mechanisms

---

## ğŸ” Quick Reference

### Essential Endpoints

```
Wallet:
GET    /api/wallet                    # Get balance
POST   /api/wallet/deposit            # Add money
POST   /api/wallet/withdraw           # Withdraw (contractors)
GET    /api/wallet/transactions       # History

Offers:
POST   /api/offer/application/:id/send    # Send offer (application)
POST   /api/offer/invite/:id/send         # Send offer (invite)
POST   /api/offer/direct/:id/send         # Send offer (direct)
POST   /api/offer/:id/accept               # Accept offer
POST   /api/offer/:id/reject               # Reject offer
POST   /api/offer/:id/cancel               # Cancel offer

Jobs:
POST   /api/job/:id/complete          # Mark complete
POST   /api/job/:id/cancel            # Cancel job
PATCH  /api/job/:id/status            # Update status
```

### Commission Calculation

```typescript
const calculateCommission = (jobBudget: number) => ({
  platformFee: jobBudget * 0.05, // 5%
  serviceFee: jobBudget * 0.2, // 20%
  contractorPayout: jobBudget * 0.8, // 80%
  totalCharge: jobBudget * 1.05, // 105%
  adminTotal: jobBudget * 0.25, // 25%
});
```

### Status Flow

```
Job: open â†’ assigned â†’ in_progress â†’ completed
Offer: pending â†’ accepted â†’ completed
Application: pending â†’ accepted/rejected
```

---

## ğŸ“š Documentation Structure

This documentation is organized into 6 focused documents:

1. **1.SYSTEM_OVERVIEW.md** (This file)
   - High-level system overview
   - Commission structure
   - Money flow
   - Architecture

2. **2.BACKEND_IMPLEMENTATION.md**
   - Complete backend implementation guide
   - Database models
   - API endpoints
   - Service layer code

3. **3.FRONTEND_API_GUIDE.md**
   - Frontend/mobile integration
   - API reference
   - Code examples (React/Flutter)
   - Error handling

4. **4.STRIPE_INTEGRATION.md**
   - Stripe setup guide
   - Payment Intents
   - Stripe Connect
   - Webhook handling

5. **5.TESTING_GUIDE.md**
   - Testing scenarios
   - Test data
   - Automated tests
   - Manual testing

6. **6.PRODUCTION_DEPLOYMENT.md**
   - Deployment checklist
   - Environment configuration
   - Monitoring setup
   - Troubleshooting

---

## ğŸ†˜ Getting Help

### For Backend Developers

- Read [2.BACKEND_IMPLEMENTATION.md](./2.BACKEND_IMPLEMENTATION.md)
- Check code in `src/api/wallet/`, `src/api/offer/`
- Review database models in `src/db/models/`

### For Frontend Developers

- Read [3.FRONTEND_API_GUIDE.md](./3.FRONTEND_API_GUIDE.md)
- Check API documentation at `/api-docs`
- Use Postman collection for testing

### For DevOps

- Read [6.PRODUCTION_DEPLOYMENT.md](./6.PRODUCTION_DEPLOYMENT.md)
- Check environment variables
- Review monitoring setup

---

## âœ… Production Readiness

### System Status: âœ… PRODUCTION READY

**Core Features**: 100% Complete

- âœ… Wallet system
- âœ… Offer system
- âœ… Job payment processing
- âœ… Transaction history
- âœ… Automated jobs
- âœ… Notifications

**Quality Assurance**: Complete

- âœ… Atomic transactions
- âœ… Race condition prevention
- âœ… Input validation
- âœ… Error handling
- âœ… Authorization checks

**Documentation**: Complete

- âœ… System overview
- âœ… Implementation guide
- âœ… API documentation
- âœ… Testing guide
- âœ… Deployment guide

**Optional Enhancements** (Future):

- â³ Stripe integration (for real payment processing)
- â³ Dispute resolution
- â³ Multi-currency support

---

## ğŸ“ Changelog

### Version 2.0.0 (January 24, 2026)

- âœ… Consolidated documentation (6 core documents)
- âœ… Removed duplicated content
- âœ… Improved organization
- âœ… Added quick navigation
- âœ… Updated status to Production Ready

### Version 1.0.0 (November 13, 2025)

- âœ… Initial release
- âœ… Complete wallet system
- âœ… Offer management
- âœ… Job payment processing
- âœ… Transaction history
- âœ… Automated jobs

---

**Next Steps**: Choose your role and read the corresponding guide:

- Backend Dev â†’ [2.BACKEND_IMPLEMENTATION.md](./2.BACKEND_IMPLEMENTATION.md)
- Frontend Dev â†’ [3.FRONTEND_API_GUIDE.md](./3.FRONTEND_API_GUIDE.md)
- Stripe Setup â†’ [4.STRIPE_INTEGRATION.md](./4.STRIPE_INTEGRATION.md)
