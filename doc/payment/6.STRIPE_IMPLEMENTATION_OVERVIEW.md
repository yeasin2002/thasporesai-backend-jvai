# 5. Stripe Implementation Overview

**Version**: 1.0.0  
**Last Updated**: January 24, 2026  
**Status**: Implementation Guide

---

## Purpose

This document provides a high-level overview of what you need to implement for Stripe integration, which Stripe APIs to use for each route, and clear instructions on how everything fits together.

---

## Table of Contents

1. [What You're Building](#what-youre-building)
2. [Stripe APIs Overview](#stripe-apis-overview)
3. [Route-by-Route Implementation](#route-by-route-implementation)
4. [Data Flow Diagrams](#data-flow-diagrams)
5. [Key Concepts](#key-concepts)
6. [Common Pitfalls](#common-pitfalls)

---

## What You're Building

### Current State (Manual)

Right now, your payment system works entirely in-memory:

- Customer "deposits" money â†’ Balance increases instantly (no real payment)
- Contractor "withdraws" money â†’ Balance decreases instantly (no real payout)
- Everything is tracked in your database, but no real money moves

### Future State (Stripe Integrated)

After integration, real money will flow:

- Customer deposits â†’ Real credit card charge via Stripe
- Contractor withdraws â†’ Real bank transfer via Stripe
- Stripe handles all payment processing, compliance, and security
- Your system orchestrates the flow and maintains records

### Three Main Components

**1. Customer Deposits (Payment Intents API)**

- Customers add money to their wallet using credit/debit cards
- Stripe processes the payment securely
- Your backend confirms payment via webhook
- Wallet balance updates after confirmation

**2. Contractor Onboarding (Connect API)**

- Contractors create Stripe accounts to receive payouts
- Stripe handles identity verification and compliance
- Your backend tracks account status
- Contractors add bank account details through Stripe

**3. Contractor Withdrawals (Transfers API)**

- Contractors withdraw earnings to their bank accounts
- Stripe transfers money from your platform to contractor
- Your backend tracks transfer status
- Money arrives in 2-3 business days

---

## Stripe APIs Overview

### 1. Payment Intents API

**Purpose**: Process one-time payments from customers

**When to Use**: Customer deposits money into wallet

**Key Concepts**:

- **Payment Intent**: Represents a payment from customer to your platform
- **Client Secret**: Secure token for frontend to confirm payment
- **Payment Method**: Customer's credit/debit card
- **Confirmation**: Can be automatic or manual

**Typical Flow**:

```
1. Backend creates Payment Intent
2. Backend returns client secret to frontend
3. Frontend collects card details
4. Frontend confirms payment with Stripe
5. Stripe sends webhook to backend
6. Backend updates wallet balance
```

**API Endpoints You'll Use**:

- `POST /v1/payment_intents` - Create payment intent
- Webhooks: `payment_intent.succeeded`, `payment_intent.payment_failed`

**Documentation**: https://stripe.com/docs/payments/payment-intents

---

### 2. Connect API (Express Accounts)

**Purpose**: Create Stripe accounts for contractors to receive money

**When to Use**: Contractor wants to withdraw earnings

**Key Concepts**:

- **Connected Account**: Separate Stripe account for each contractor
- **Express Account**: Stripe-hosted onboarding (easiest option)
- **Account Link**: URL for contractor to complete onboarding
- **Capabilities**: What the account can do (transfers, payouts)

**Typical Flow**:

```
1. Contractor requests payout account
2. Backend creates Express account
3. Backend generates onboarding link
4. Contractor completes onboarding on Stripe
5. Stripe sends webhook when complete
6. Backend marks account as active
```

**API Endpoints You'll Use**:

- `POST /v1/accounts` - Create connected account
- `POST /v1/account_links` - Generate onboarding URL
- `GET /v1/accounts/:id` - Check account status
- Webhooks: `account.updated`, `account.external_account.created`

**Documentation**: https://stripe.com/docs/connect/express-accounts

---

### 3. Transfers API

**Purpose**: Send money from your platform to contractor accounts

**When to Use**: Contractor withdraws money from wallet

**Key Concepts**:

- **Transfer**: Money movement from platform to connected account
- **Destination**: Contractor's Stripe account ID
- **Automatic Payout**: Stripe automatically sends to bank account
- **Payout Schedule**: When money arrives (instant, daily, weekly)

**Typical Flow**:

```
1. Contractor requests withdrawal
2. Backend validates balance
3. Backend creates Stripe transfer
4. Stripe moves money to contractor account
5. Stripe automatically pays out to bank
6. Stripe sends webhook when complete
7. Backend updates transaction status
```

**API Endpoints You'll Use**:

- `POST /v1/transfers` - Create transfer
- Webhooks: `transfer.created`, `transfer.paid`, `transfer.failed`

**Documentation**: https://stripe.com/docs/connect/bank-debit-card-payouts

---

### 4. Webhooks API

**Purpose**: Receive real-time notifications from Stripe

**When to Use**: Always - critical for confirming payments and transfers

**Key Concepts**:

- **Webhook**: HTTP POST request from Stripe to your server
- **Event**: What happened (payment succeeded, transfer failed, etc.)
- **Signature**: Cryptographic proof the webhook is from Stripe
- **Idempotency**: Handle duplicate webhooks gracefully

**Typical Flow**:

```
1. Something happens in Stripe (payment succeeds)
2. Stripe sends POST request to your webhook URL
3. Your backend verifies signature
4. Your backend processes event
5. Your backend returns 200 OK
6. Stripe marks webhook as delivered
```

**Events You'll Handle**:

- `payment_intent.succeeded` - Payment completed
- `payment_intent.payment_failed` - Payment failed
- `transfer.paid` - Transfer completed
- `transfer.failed` - Transfer failed
- `account.updated` - Account status changed

**Documentation**: https://stripe.com/docs/webhooks

---

## Route-by-Route Implementation

### Route 1: POST /api/wallet/deposit

**Purpose**: Customer adds money to wallet

**Current Implementation**: Directly increases balance

**Stripe Integration**: Create Payment Intent

**What to Change**:

1. **Get or Create Stripe Customer**

```typescript
// Check if user has Stripe customer ID
if (!user.stripeCustomerId) {
  const customer = await stripe.customers.create({
    email: user.email,
    metadata: { userId: user._id.toString() },
  });
  user.stripeCustomerId = customer.id;
  await user.save();
}
```

2. **Create Payment Intent**

```typescript
const paymentIntent = await stripe.paymentIntents.create({
  amount: Math.round(amount * 100), // Convert dollars to cents
  currency: "usd",
  customer: user.stripeCustomerId,
  payment_method: paymentMethodId, // From request body
  confirm: true, // Confirm immediately
  metadata: {
    userId: user._id.toString(),
    walletId: wallet._id.toString(),
    type: "wallet_deposit",
  },
});
```

3. **Create Pending Transaction**

```typescript
const transaction = await db.transaction.create({
  type: "deposit",
  amount,
  from: userId,
  to: userId,
  status: "pending", // Wait for webhook
  stripePaymentIntentId: paymentIntent.id,
  description: `Wallet deposit of $${amount}`,
});
```

4. **Update Pending Deposits**

```typescript
wallet.pendingDeposits += amount;
await wallet.save();
```

5. **Return Response**

```typescript
return sendSuccess(res, 200, "Payment initiated", {
  paymentIntent: {
    id: paymentIntent.id,
    status: paymentIntent.status,
    clientSecret: paymentIntent.client_secret,
  },
  transaction: { id: transaction._id, status: "pending" },
});
```

**Stripe API Used**: Payment Intents API

**Webhook Needed**: `payment_intent.succeeded`

**Testing**:

- Use test card: `4242 4242 4242 4242`
- Verify Payment Intent created in Stripe Dashboard
- Trigger webhook with Stripe CLI
- Verify wallet balance updates

---

### Route 2: POST /api/webhooks/stripe

**Purpose**: Receive notifications from Stripe

**Current Implementation**: Doesn't exist

**Stripe Integration**: Handle webhook events

**What to Implement**:

1. **Verify Signature** (CRITICAL for security)

```typescript
const sig = req.headers["stripe-signature"];
const event = stripe.webhooks.constructEvent(
  req.body, // Must be raw body, not parsed JSON
  sig,
  process.env.STRIPE_WEBHOOK_SECRET
);
```

2. **Handle payment_intent.succeeded**

```typescript
if (event.type === "payment_intent.succeeded") {
  const paymentIntent = event.data.object;

  // Find transaction
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
  });

  // Update transaction
  transaction.status = "completed";
  transaction.completedAt = new Date();
  await transaction.save();

  // Update wallet
  const wallet = await db.wallet.findById(transaction.to);
  wallet.balance += transaction.amount;
  wallet.pendingDeposits -= transaction.amount;
  await wallet.save();
}
```

3. **Handle payment_intent.payment_failed**

```typescript
if (event.type === "payment_intent.payment_failed") {
  const paymentIntent = event.data.object;

  // Find transaction
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
  });

  // Mark as failed
  transaction.status = "failed";
  transaction.stripeError = paymentIntent.last_payment_error?.message;
  await transaction.save();

  // Remove from pending
  const wallet = await db.wallet.findById(transaction.to);
  wallet.pendingDeposits -= transaction.amount;
  await wallet.save();
}
```

4. **Return 200 OK**

```typescript
return res.json({ received: true });
```

**Stripe API Used**: Webhooks API

**Important Notes**:

- Must use `express.raw()` middleware for signature verification
- Register webhook route BEFORE `express.json()` middleware
- Always return 200, even if processing fails (prevents retries)
- Log all events for debugging

**Testing**:

- Use Stripe CLI: `stripe listen --forward-to localhost:4000/api/webhooks/stripe`
- Trigger events: `stripe trigger payment_intent.succeeded`
- Check logs and database

---

### Route 3: POST /api/wallet/connect-account

**Purpose**: Contractor creates payout account

**Current Implementation**: Doesn't exist

**Stripe Integration**: Create Connect Express account

**What to Implement**:

1. **Verify User is Contractor**

```typescript
if (user.role !== "contractor") {
  return sendBadRequest(res, "Only contractors can create payout accounts");
}
```

2. **Check if Account Exists**

```typescript
if (user.stripeAccountId) {
  return sendSuccess(res, 200, "Account already exists", {
    accountId: user.stripeAccountId,
    status: user.stripeAccountStatus,
  });
}
```

3. **Create Express Account**

```typescript
const account = await stripe.accounts.create({
  type: "express",
  country: "US",
  email: user.email,
  capabilities: {
    transfers: { requested: true },
  },
  metadata: {
    userId: user._id.toString(),
  },
});
```

4. **Save Account ID**

```typescript
user.stripeAccountId = account.id;
user.stripeAccountStatus = "pending";
user.stripeOnboardingComplete = false;
await user.save();
```

5. **Generate Onboarding Link**

```typescript
const accountLink = await stripe.accountLinks.create({
  account: account.id,
  refresh_url: `${process.env.CLIENT_URL}/dashboard/settings/payout?refresh=true`,
  return_url: `${process.env.CLIENT_URL}/dashboard/settings/payout?success=true`,
  type: "account_onboarding",
});
```

6. **Return Onboarding URL**

```typescript
return sendSuccess(res, 201, "Account created", {
  accountId: account.id,
  onboardingUrl: accountLink.url,
});
```

**Stripe API Used**: Connect API

**Webhook Needed**: `account.updated`

**Frontend Flow**:

1. Call this endpoint
2. Redirect user to `onboardingUrl`
3. User completes onboarding on Stripe
4. Stripe redirects back to `return_url`
5. Frontend checks account status

**Testing**:

- Create test contractor
- Call endpoint
- Open onboarding URL
- Use test data (SSN: 000-00-0000)
- Complete onboarding
- Verify webhook received

---

### Route 4: POST /api/wallet/withdraw

**Purpose**: Contractor withdraws earnings

**Current Implementation**: Directly decreases balance

**Stripe Integration**: Create Stripe Transfer

**What to Change**:

1. **Check Stripe Account Exists**

```typescript
if (!user.stripeAccountId) {
  return sendBadRequest(res, "Please complete payout account setup first");
}

if (!user.stripeOnboardingComplete) {
  return sendBadRequest(res, "Please complete account verification");
}
```

2. **Deduct Balance Atomically** (keep existing logic)

```typescript
const wallet = await db.wallet.findOneAndUpdate(
  {
    user: userId,
    balance: { $gte: amount },
    isFrozen: false,
  },
  {
    $inc: { balance: -amount, totalWithdrawals: amount },
  },
  { new: true }
);

if (!wallet) {
  // Handle insufficient balance
}
```

3. **Create Stripe Transfer**

```typescript
const transfer = await stripe.transfers.create({
  amount: Math.round(amount * 100), // Convert to cents
  currency: "usd",
  destination: user.stripeAccountId,
  metadata: {
    userId: user._id.toString(),
    walletId: wallet._id.toString(),
    type: "contractor_withdrawal",
  },
});
```

4. **Create Transaction Record**

```typescript
const transaction = await db.transaction.create({
  type: "withdrawal",
  amount,
  from: userId,
  to: userId,
  status: "pending", // Wait for webhook
  stripeTransferId: transfer.id,
  description: `Withdrawal of $${amount}`,
});
```

5. **Return Response**

```typescript
return sendSuccess(res, 200, "Withdrawal initiated", {
  amount,
  newBalance: wallet.balance,
  transferId: transfer.id,
  estimatedArrival: "2-3 business days",
  transaction: { id: transaction._id, status: "pending" },
});
```

6. **Add Rollback on Error**

```typescript
catch (error) {
  // If Stripe fails, refund the wallet
  await db.wallet.findOneAndUpdate(
    { user: userId },
    { $inc: { balance: amount, totalWithdrawals: -amount } }
  );
  throw error;
}
```

**Stripe API Used**: Transfers API

**Webhook Needed**: `transfer.paid`, `transfer.failed`

**Testing**:

- Create contractor with completed onboarding
- Add balance to wallet
- Call withdrawal endpoint
- Verify transfer in Stripe Dashboard
- Trigger webhook
- Verify transaction status updates

---

## Data Flow Diagrams

### Customer Deposit Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/wallet/deposit
       â”‚    { amount: 100, paymentMethodId: "pm_xxx" }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Your Backend                      â”‚
â”‚                                             â”‚
â”‚  2. Get/Create Stripe Customer              â”‚
â”‚  3. Create Payment Intent                   â”‚
â”‚  4. Create pending transaction              â”‚
â”‚  5. Update pendingDeposits                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Return client secret
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer  â”‚
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. Confirm payment with Stripe
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Stripe                         â”‚
â”‚                                             â”‚
â”‚  8. Process payment                         â”‚
â”‚  9. Send webhook: payment_intent.succeeded  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 10. POST /api/webhooks/stripe
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Your Backend                      â”‚
â”‚                                             â”‚
â”‚  11. Verify webhook signature               â”‚
â”‚  12. Update transaction status: completed   â”‚
â”‚  13. Add amount to wallet balance           â”‚
â”‚  14. Decrease pendingDeposits               â”‚
â”‚  15. Send notification to customer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points**:

- Payment Intent created immediately
- Balance updated only after webhook confirmation
- Pending deposits tracked separately
- Webhook signature must be verified

---

### Contractor Onboarding Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contractor  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/wallet/connect-account
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Your Backend                      â”‚
â”‚                                             â”‚
â”‚  2. Check if account exists                 â”‚
â”‚  3. Create Express account                  â”‚
â”‚  4. Save account ID to user                 â”‚
â”‚  5. Generate onboarding link                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Return onboarding URL
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contractor  â”‚
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. Redirect to Stripe onboarding
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Stripe Onboarding UI                â”‚
â”‚                                             â”‚
â”‚  8. Collect business info                   â”‚
â”‚  9. Verify identity                         â”‚
â”‚  10. Add bank account                       â”‚
â”‚  11. Complete onboarding                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 12. Redirect back to your app
       â”‚ 13. Send webhook: account.updated
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Your Backend                      â”‚
â”‚                                             â”‚
â”‚  14. Verify webhook signature               â”‚
â”‚  15. Update account status                  â”‚
â”‚  16. Set onboardingComplete = true          â”‚
â”‚  17. Send notification to contractor        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points**:

- Stripe handles all onboarding UI
- Identity verification done by Stripe
- Bank account details never touch your server
- Webhook confirms completion

---

### Contractor Withdrawal Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contractor  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/wallet/withdraw
       â”‚    { amount: 80 }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Your Backend                      â”‚
â”‚                                             â”‚
â”‚  2. Check account exists & verified         â”‚
â”‚  3. Check sufficient balance                â”‚
â”‚  4. Deduct from wallet (atomic)             â”‚
â”‚  5. Create Stripe Transfer                  â”‚
â”‚  6. Create pending transaction              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. Return success
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contractor  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚         Stripe Processing           â”‚
       â”‚                                     â”‚
       â”‚  8. Transfer to connected account   â”‚
       â”‚  9. Automatic payout to bank        â”‚
       â”‚  10. Send webhook: transfer.paid    â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ 11. POST /api/webhooks/stripe
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           Your Backend              â”‚
       â”‚                                     â”‚
       â”‚  12. Verify webhook signature       â”‚
       â”‚  13. Update transaction: completed  â”‚
       â”‚  14. Send notification              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚      Contractor Bank Account        â”‚
       â”‚                                     â”‚
       â”‚  15. Money arrives (2-3 days)       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points**:

- Balance deducted immediately
- Transfer created in Stripe
- Webhook confirms completion
- Money arrives in 2-3 business days

---

## Key Concepts

### 1. Test Mode vs Live Mode

**Test Mode**:

- Use test API keys (start with `sk_test_` and `pk_test_`)
- Use test card numbers (e.g., `4242 4242 4242 4242`)
- No real money is processed
- Perfect for development and testing

**Live Mode**:

- Use live API keys (start with `sk_live_` and `pk_live_`)
- Real credit cards and bank accounts
- Real money is processed
- Use only in production

**Important**: Never mix test and live keys!

---

### 2. Webhook Signature Verification

**Why It's Critical**:

- Anyone can send POST requests to your webhook URL
- Without verification, attackers could fake payments
- Signature proves the webhook is from Stripe

**How It Works**:

```typescript
// Stripe signs the webhook with your secret
const event = stripe.webhooks.constructEvent(
  req.body, // Raw body (not parsed JSON)
  req.headers["stripe-signature"],
  process.env.STRIPE_WEBHOOK_SECRET
);
```

**Common Mistakes**:

- Using parsed JSON body (must be raw)
- Wrong webhook secret
- Not handling signature verification errors

---

### 3. Idempotency

**Problem**: What if a request is sent twice?

- Network timeout causes retry
- User clicks "Deposit" button twice
- Webhook is delivered twice

**Solution**: Idempotency keys

```typescript
const paymentIntent = await stripe.paymentIntents.create(
  {
    amount: 10000,
    currency: "usd",
    // ... other params
  },
  {
    idempotencyKey: `deposit_${userId}_${Date.now()}`,
  }
);
```

**How It Works**:

- Stripe remembers requests by idempotency key
- Duplicate requests return the same result
- No double charges

---

### 4. Amounts in Cents

**Stripe Rule**: All amounts must be in cents (smallest currency unit)

**Your Code**: Amounts are in dollars

**Conversion**:

```typescript
// Deposit $100
const amountInDollars = 100;
const amountInCents = Math.round(amountInDollars * 100); // 10000

await stripe.paymentIntents.create({
  amount: amountInCents, // 10000 cents = $100
  currency: "usd",
});
```

**Important**: Always use `Math.round()` to avoid floating point issues

---

### 5. Metadata

**Purpose**: Attach custom data to Stripe objects

**Use Cases**:

- Link Stripe objects to your database records
- Track the purpose of a payment
- Store user information

**Example**:

```typescript
await stripe.paymentIntents.create({
  amount: 10000,
  currency: "usd",
  metadata: {
    userId: "507f1f77bcf86cd799439011",
    walletId: "507f1f77bcf86cd799439012",
    type: "wallet_deposit",
    environment: "production",
  },
});
```

**Benefits**:

- Visible in Stripe Dashboard
- Included in webhooks
- Helps with debugging and reconciliation

---

### 6. Webhook Retries

**Stripe Behavior**:

- If your webhook returns non-200 status, Stripe retries
- Retries with exponential backoff
- Up to 3 days of retries

**Your Responsibility**:

- Always return 200, even if processing fails
- Handle duplicate webhooks gracefully
- Log errors for manual investigation

**Example**:

```typescript
try {
  await handlePaymentIntentSucceeded(paymentIntent);
  return res.json({ received: true });
} catch (error) {
  console.error("Webhook processing failed:", error);
  // Still return 200 to prevent retries
  return res.json({ received: true, error: "Processing failed" });
}
```

---

## Common Pitfalls

### 1. Not Using Raw Body for Webhooks

**Problem**:

```typescript
// âŒ WRONG - Body is parsed JSON
app.use(express.json());
app.post("/webhooks/stripe", handleWebhook);
```

**Solution**:

```typescript
// âœ… CORRECT - Register webhook before body parser
app.post(
  "/webhooks/stripe",
  express.raw({ type: "application/json" }),
  handleWebhook
);
app.use(express.json());
```

---

### 2. Updating Balance Before Webhook

**Problem**:

```typescript
// âŒ WRONG - Balance updated immediately
const paymentIntent = await stripe.paymentIntents.create({...});
wallet.balance += amount; // Payment might fail!
await wallet.save();
```

**Solution**:

```typescript
// âœ… CORRECT - Wait for webhook
const paymentIntent = await stripe.paymentIntents.create({...});
wallet.pendingDeposits += amount; // Track as pending
await wallet.save();

// In webhook handler:
if (event.type === 'payment_intent.succeeded') {
  wallet.balance += amount; // Now update balance
  wallet.pendingDeposits -= amount;
  await wallet.save();
}
```

---

### 3. Not Handling Failed Payments

**Problem**:

```typescript
// âŒ WRONG - Only handles success
if (event.type === "payment_intent.succeeded") {
  // Update balance
}
// What about failures?
```

**Solution**:

```typescript
// âœ… CORRECT - Handle both success and failure
if (event.type === "payment_intent.succeeded") {
  // Update balance
  wallet.balance += amount;
  wallet.pendingDeposits -= amount;
}

if (event.type === "payment_intent.payment_failed") {
  // Remove from pending
  wallet.pendingDeposits -= amount;
  // Notify user
  await sendNotification(userId, "Payment failed");
}
```

---

### 4. Forgetting to Rollback on Stripe Errors

**Problem**:

```typescript
// âŒ WRONG - Balance deducted but transfer fails
wallet.balance -= amount;
await wallet.save();

const transfer = await stripe.transfers.create({...}); // Might fail!
```

**Solution**:

```typescript
// âœ… CORRECT - Rollback on error
wallet.balance -= amount;
await wallet.save();

try {
  const transfer = await stripe.transfers.create({...});
} catch (error) {
  // Rollback
  wallet.balance += amount;
  await wallet.save();
  throw error;
}
```

---

### 5. Not Checking Onboarding Status

**Problem**:

```typescript
// âŒ WRONG - Create transfer without checking
const transfer = await stripe.transfers.create({
  destination: user.stripeAccountId, // Might not be verified!
});
```

**Solution**:

```typescript
// âœ… CORRECT - Check onboarding first
if (!user.stripeAccountId) {
  throw new Error("No payout account");
}

if (!user.stripeOnboardingComplete) {
  throw new Error("Complete account verification first");
}

const transfer = await stripe.transfers.create({
  destination: user.stripeAccountId,
});
```

---

### 6. Exposing Stripe Secret Key

**Problem**:

```typescript
// âŒ WRONG - Secret key in frontend code
const stripe = Stripe("sk_test_...");
```

**Solution**:

```typescript
// âœ… CORRECT - Secret key only in backend
// Backend: src/lib/stripe.ts
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

// Frontend: Only use publishable key
const stripe = Stripe("pk_test_...");
```

---

### 7. Not Testing with Stripe CLI

**Problem**:

- Deploying to production without testing webhooks
- Webhooks fail in production
- No way to debug

**Solution**:

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Forward webhooks to local server
stripe listen --forward-to localhost:4000/api/webhooks/stripe

# Trigger test events
stripe trigger payment_intent.succeeded
stripe trigger transfer.paid

# Test your webhook handling locally
```

---

## Implementation Checklist

### Before You Start

- [ ] Read Stripe documentation
- [ ] Understand Payment Intents
- [ ] Understand Connect Express accounts
- [ ] Understand Transfers
- [ ] Understand Webhooks

### Phase 1: Setup

- [ ] Create Stripe account
- [ ] Get test API keys
- [ ] Install Stripe SDK
- [ ] Configure environment variables
- [ ] Update database models
- [ ] Create Stripe service

### Phase 2: Deposits

- [ ] Update deposit service
- [ ] Create webhook handler
- [ ] Handle payment success
- [ ] Handle payment failure
- [ ] Test with Stripe CLI
- [ ] Test with test cards

### Phase 3: Onboarding

- [ ] Create connect account service
- [ ] Generate onboarding links
- [ ] Handle account webhooks
- [ ] Track onboarding status
- [ ] Test complete flow

### Phase 4: Withdrawals

- [ ] Update withdrawal service
- [ ] Create transfers
- [ ] Handle transfer webhooks
- [ ] Add rollback logic
- [ ] Test complete flow

### Phase 5: Production

- [ ] Get live API keys
- [ ] Configure production webhooks
- [ ] Deploy to production
- [ ] Monitor for errors
- [ ] Document everything

---

## Quick Reference

### Test Cards

**Successful Payment**:

- Card: `4242 4242 4242 4242`
- Expiry: Any future date
- CVC: Any 3 digits

**Declined Payment**:

- Card: `4000 0000 0000 0002`

**Requires Authentication**:

- Card: `4000 0025 0000 3155`

### Test Data for Onboarding

**SSN**: `000-00-0000`  
**DOB**: `01/01/1990`  
**Address**: Any US address  
**Bank Account**: `000123456789` (routing: `110000000`)

### Webhook Events

**Payment Events**:

- `payment_intent.succeeded`
- `payment_intent.payment_failed`
- `payment_intent.canceled`

**Transfer Events**:

- `transfer.created`
- `transfer.paid`
- `transfer.failed`

**Account Events**:

- `account.updated`
- `account.external_account.created`

### Amount Conversion

```typescript
// Dollars to cents
const cents = Math.round(dollars * 100);

// Cents to dollars
const dollars = cents / 100;
```

### Stripe CLI Commands

```bash
# Listen for webhooks
stripe listen --forward-to localhost:4000/api/webhooks/stripe

# Trigger events
stripe trigger payment_intent.succeeded
stripe trigger transfer.paid
stripe trigger account.updated

# View logs
stripe logs tail
```

---

## Next Steps

1. **Read the Task List**: See `4.STRIPE_INTEGRATION_TASKLIST.md` for detailed tasks
2. **Review Implementation Guide**: See `3.STRIPE_INTEGRATION_GUIDE.md` for code examples
3. **Start with Phase 1**: Set up Stripe account and environment
4. **Test Everything**: Use Stripe CLI and test mode extensively
5. **Deploy Carefully**: Test in staging before production

---

## Support Resources

**Stripe Documentation**:

- Payment Intents: https://stripe.com/docs/payments/payment-intents
- Connect: https://stripe.com/docs/connect
- Webhooks: https://stripe.com/docs/webhooks

**Your Documentation**:

- [1. System Overview](./1.MAIN-REFERENCE.md)
- [2. Backend Implementation](./2.BACKEND_IMPLEMENTATION.md)
- [3. Stripe Integration Guide](./3.STRIPE_INTEGRATION_GUIDE.md)
- [4. Task List](./4.STRIPE_INTEGRATION_TASKLIST.md)

**Stripe Support**:

- Dashboard: https://dashboard.stripe.com
- Support: https://support.stripe.com
- Community: https://stripe.com/community

---

**Good luck with your implementation! ğŸš€**
