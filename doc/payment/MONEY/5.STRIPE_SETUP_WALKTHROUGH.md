# Stripe Setup Walkthrough for JobSphere

**Complete Beginner's Guide - Never Used Stripe Before**

**Version**: 1.0.0  
**Last Updated**: November 25, 2025  
**Estimated Time**: 2-3 hours  
**Difficulty**: Beginner-Friendly

---

## Table of Contents

1. [What is Stripe and Why Do You Need It?](#what-is-stripe-and-why-do-you-need-it)
2. [Part 1: Creating Your Stripe Account](#part-1-creating-your-stripe-account)
3. [Part 2: Understanding the Stripe Dashboard](#part-2-understanding-the-stripe-dashboard)
4. [Part 3: Getting Your API Keys](#part-3-getting-your-api-keys)
5. [Part 4: Setting Up Webhooks](#part-4-setting-up-webhooks)
6. [Part 5: Enabling Stripe Connect](#part-5-enabling-stripe-connect)
7. [Part 6: Configuring Your Project](#part-6-configuring-your-project)
8. [Part 7: Testing Your Integration](#part-7-testing-your-integration)
9. [Part 8: Understanding How Money Flows](#part-8-understanding-how-money-flows)
10. [Part 9: Going Live (Production)](#part-9-going-live-production)

---

## What is Stripe and Why Do You Need It?

### The Problem Without Stripe

Right now, your JobSphere wallet system works like this:

```
Customer clicks "Deposit $100"
    â†“
Your database: wallet.balance += 100
    â†“
Customer sees $100 in wallet
    â†“
BUT... NO REAL MONEY WAS CHARGED! ðŸš¨
```

**This means:**

- âŒ You can't actually charge customers' credit cards
- âŒ You can't send real money to contractors
- âŒ It's just numbers in a database (play money)
- âŒ You can't launch your business

### The Solution With Stripe

Stripe is a payment processor that:

- âœ… Charges customers' credit cards for real
- âœ… Sends real money to contractors' bank accounts
- âœ… Handles all the complex payment stuff
- âœ… Keeps you legally compliant

### How Your Wallet Will Work With Stripe

**Before Stripe (Current - Fake Money):**

```
Customer â†’ Your API â†’ Database balance += 100
```

**After Stripe (Real Money):**

```
Customer â†’ Your API â†’ Stripe charges card â†’ Webhook confirms â†’ Database balance += 100
                         â†“
                    Real money in your Stripe account
```

---

## Part 1: Creating Your Stripe Account

### Step 1.1: Sign Up for Stripe

1. **Go to Stripe's website**

   - Open your browser
   - Visit: https://stripe.com
   - Click the **"Sign up"** button (top right corner)

2. **Enter your email**

   - Use your business email (e.g., admin@jobsphere.com)
   - Create a strong password
   - Click **"Create account"**

3. **Verify your email**
   - Check your inbox
   - Click the verification link
   - You'll be redirected to Stripe Dashboard

### Step 1.2: Complete Your Business Profile

1. **Business Information**

   - Business name: `JobSphere` (or your company name)
   - Business type: Select `Company` or `Individual` (based on your setup)
   - Country: Select your country (e.g., `United States`)
   - Click **"Continue"**

2. **Personal Information**

   - Your full name
   - Date of birth
   - Phone number
   - Click **"Continue"**

3. **Business Details**

   - Industry: Select `Marketplace` or `Software`
   - Website: Your website URL (or leave blank for now)
   - Business description: "Service marketplace connecting customers with contractors"
   - Click **"Continue"**

4. **Skip Payment Details for Now**
   - You can add bank account later
   - Click **"Skip for now"** or **"I'll do this later"**

### Step 1.3: Activate Test Mode

**IMPORTANT:** Always start in Test Mode!

1. Look at the top-right corner of the dashboard
2. You'll see a toggle switch that says **"Test mode"**
3. Make sure it's **ON** (usually blue or highlighted)
4. When it's ON, you'll see "Test mode" badge everywhere

**Why Test Mode?**

- No real money is charged
- You can test with fake credit cards
- Safe to experiment and learn
- Free to use

---

## Part 2: Understanding the Stripe Dashboard

### Dashboard Overview

When you log in, you'll see several sections:

**Left Sidebar Menu:**

- **Home**: Overview of your account
- **Payments**: See all payment transactions
- **Customers**: List of customers who paid
- **Connect**: For paying contractors (we'll use this!)
- **Developers**: API keys, webhooks, logs
- **Settings**: Account settings

**Main Dashboard:**

- **Balance**: Money in your Stripe account
- **Recent payments**: Latest transactions
- **Charts**: Visual representation of payments

### Important Sections for JobSphere

1. **Payments** - Where you'll see customer deposits
2. **Connect** - Where you'll manage contractor payouts
3. **Developers** - Where you'll get API keys and setup webhooks
4. **Logs** - Where you'll debug issues

---

## Part 3: Getting Your API Keys

### What Are API Keys?

API keys are like passwords that let your backend code talk to Stripe.

**You need 2 types:**

1. **Publishable Key** (pk_test_xxx) - Used in frontend (safe to expose)
2. **Secret Key** (sk_test_xxx) - Used in backend (NEVER expose!)

### Step 3.1: Find Your API Keys

1. **Navigate to Developers Section**

   - Click **"Developers"** in the left sidebar
   - Click **"API keys"** tab

2. **You'll See Two Keys**

   **Publishable key:**

   ```
   pk_test_51AbCdEfGhIjKlMnOpQrStUvWxYz...
   ```

   - Starts with `pk_test_` (test mode) or `pk_live_` (production)
   - Safe to use in frontend code
   - Used to create payment methods

   **Secret key:**

   ```
   sk_test_51AbCdEfGhIjKlMnOpQrStUvWxYz...
   ```

   - Starts with `sk_test_` (test mode) or `sk_live_` (production)
   - MUST be kept secret
   - Used in backend to charge cards

3. **Copy Your Keys**
   - Click **"Reveal test key"** for the Secret key
   - Copy both keys to a safe place (we'll use them soon)

### Step 3.2: Add Keys to Your Project

1. **Open your project folder**

   ```
   C:\Yeasin\office\thasporesai-backend-jvai\
   ```

2. **Open the `.env` file**

   - If it doesn't exist, create it in the root folder
   - This file stores your secret configuration

3. **Add these lines to `.env`:**

   ```env
   # Stripe Configuration
   STRIPE_SECRET_KEY=sk_test_YOUR_SECRET_KEY_HERE
   STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_PUBLISHABLE_KEY_HERE
   STRIPE_WEBHOOK_SECRET=whsec_we_will_add_this_later

   # Payment Settings
   PAYMENT_CURRENCY=usd
   PLATFORM_NAME=JobSphere
   PLATFORM_EMAIL=support@jobsphere.com

   # Frontend URL (for redirects)
   FRONTEND_URL=http://localhost:3000
   ```

4. **Replace the placeholder keys**

   - Replace `sk_test_YOUR_SECRET_KEY_HERE` with your actual secret key
   - Replace `pk_test_YOUR_PUBLISHABLE_KEY_HERE` with your actual publishable key

5. **Save the file**

**âš ï¸ IMPORTANT SECURITY NOTES:**

- âœ… `.env` should be in your `.gitignore` file
- âœ… Never commit `.env` to GitHub
- âœ… Never share your secret key
- âœ… Each developer should have their own `.env` file

---

## Part 4: Setting Up Webhooks

### What Are Webhooks?

Webhooks are how Stripe tells your backend "Hey, a payment succeeded!" or "Hey, a payment failed!"

**Without webhooks:**

```
Customer pays â†’ Stripe charges card â†’ ??? â†’ Your app never knows!
```

**With webhooks:**

```
Customer pays â†’ Stripe charges card â†’ Stripe sends webhook â†’ Your app updates balance âœ…
```

### Step 4.1: Understanding Webhook Flow

```
1. Customer deposits $100
2. Your backend creates Payment Intent
3. Stripe charges the card (takes 2-5 seconds)
4. Stripe sends webhook to your server: "payment_intent.succeeded"
5. Your webhook handler updates wallet balance
6. Customer sees $100 in their wallet
```

### Step 4.2: Install Stripe CLI (For Local Testing)

**What is Stripe CLI?**

- A command-line tool to test webhooks locally
- Forwards Stripe webhooks to your local computer
- Essential for development

**Installation:**

**For Windows:**

1. Download from: https://github.com/stripe/stripe-cli/releases/latest
2. Download `stripe_X.X.X_windows_x86_64.zip`
3. Extract the ZIP file
4. Move `stripe.exe` to a folder in your PATH (or just keep it in your project folder)

**For Mac (using Homebrew):**

```bash
brew install stripe/stripe-cli/stripe
```

**For Linux:**

```bash
# Download and install
wget https://github.com/stripe/stripe-cli/releases/latest/download/stripe_linux_x86_64.tar.gz
tar -xvf stripe_linux_x86_64.tar.gz
sudo mv stripe /usr/local/bin/
```

### Step 4.3: Login to Stripe CLI

1. **Open your terminal/command prompt**

   ```bash
   cd C:\Yeasin\office\thasporesai-backend-jvai
   ```

2. **Login to Stripe**

   ```bash
   stripe login
   ```

3. **You'll see:**

   ```
   Your pairing code is: word-word-word
   Press Enter to open the browser
   ```

4. **Press Enter**

   - Browser opens automatically
   - Click **"Allow access"**
   - You'll see "Success! You're now authenticated"

5. **Return to terminal**
   - You'll see: "Done! The Stripe CLI is configured"

### Step 4.4: Create Webhook Endpoint in Your Code

**Already done in your project!**

Your project already has webhook handling at:

- Route: `src/api/webhooks/stripe.route.ts`
- Handlers: `src/api/webhooks/handlers/`

**The webhook endpoint will be:**

```
http://localhost:4000/api/webhooks/stripe
```

### Step 4.5: Test Webhooks Locally

1. **Start your backend server** (in one terminal):

   ```bash
   cd C:\Yeasin\office\thasporesai-backend-jvai
   bun dev
   ```

2. **Start Stripe CLI forwarding** (in another terminal):

   ```bash
   stripe listen --forward-to localhost:4000/api/webhooks/stripe
   ```

3. **You'll see:**

   ```
   Ready! Your webhook signing secret is whsec_xxxxxxxxxxxxx
   ```

4. **Copy the webhook secret**

   - Copy the `whsec_xxxxxxxxxxxxx` part
   - Open your `.env` file
   - Update this line:
     ```env
     STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx
     ```
   - Save the file
   - Restart your backend server

5. **Test the webhook**

   In a third terminal:

   ```bash
   stripe trigger payment_intent.succeeded
   ```

6. **Check your backend logs**

   You should see:

   ```
   âœ… Received webhook: payment_intent.succeeded [evt_xxx]
   ```

**If you see this, webhooks are working! ðŸŽ‰**

### Step 4.6: Setup Production Webhooks (Later)

For now, we're using Stripe CLI for local testing. When you deploy to production, you'll need to:

1. Go to Stripe Dashboard â†’ Developers â†’ Webhooks
2. Click "Add endpoint"
3. Enter your production URL: `https://yourdomain.com/api/webhooks/stripe`
4. Select events to listen to
5. Copy the webhook secret to your production `.env`

**We'll cover this in Part 9.**

---

## Part 5: Enabling Stripe Connect

### What is Stripe Connect?

Stripe Connect lets you pay contractors (your service providers).

**Think of it like:**

- Your platform = Uber
- Contractors = Drivers
- Stripe Connect = How Uber pays drivers

### Step 5.1: Enable Stripe Connect

1. **Go to Stripe Dashboard**

   - Click **"Connect"** in the left sidebar
   - Click **"Get started"**

2. **Choose Account Type**

   You'll see 3 options:

   - **Standard**: Contractors manage their own Stripe account
   - **Express**: You manage account, contractors have limited access â­ **RECOMMENDED**
   - **Custom**: You fully manage everything (complex)

   **Choose "Express"** - Best balance of control and simplicity

3. **Configure Branding**

   - Platform name: `JobSphere`
   - Support email: `support@jobsphere.com`
   - Platform icon: Upload your logo (optional)
   - Brand color: Choose your brand color (optional)

4. **Set Redirect URLs**

   These are where contractors go after connecting:

   **For development:**

   ```
   Success URL: http://localhost:3000/connect/success
   Failure URL: http://localhost:3000/connect/failure
   Refresh URL: http://localhost:3000/connect/refresh
   ```

   **For production (later):**

   ```
   Success URL: https://yourdomain.com/connect/success
   Failure URL: https://yourdomain.com/connect/failure
   Refresh URL: https://yourdomain.com/connect/refresh
   ```

5. **Click "Save"**

### Step 5.2: Get Your Connect Client ID

1. **Still in Connect settings**

   - Scroll down to find **"Client ID"**
   - It looks like: `ca_xxxxxxxxxxxxx`

2. **Copy the Client ID**

3. **Add to your `.env` file:**

   ```env
   STRIPE_CONNECT_CLIENT_ID=ca_xxxxxxxxxxxxx
   ```

4. **Save the file**

### Step 5.3: Understanding Connect Flow

**How contractors will connect their bank account:**

```
1. Contractor clicks "Connect Bank Account" in your app
2. Your backend creates Stripe Connect account
3. Contractor is redirected to Stripe's onboarding page
4. Contractor enters:
   - Personal information (name, DOB, SSN)
   - Bank account details
   - Business information (if applicable)
5. Stripe verifies their identity (KYC)
6. Contractor is redirected back to your app
7. Now they can receive payments!
```

**Your backend code already handles this!** Check:

- `src/api/wallet/services/connect-onboarding.service.ts`

---

## Part 6: Configuring Your Project

### Step 6.1: Install Stripe SDK

1. **Open terminal in your project folder:**

   ```bash
   cd C:\Yeasin\office\thasporesai-backend-jvai
   ```

2. **Install Stripe package:**

   ```bash
   bun add stripe
   ```

3. **Install TypeScript types (if needed):**
   ```bash
   bun add -D @types/stripe
   ```

### Step 6.2: Create Stripe Service File

1. **Create file:** `src/lib/stripe.ts`

2. **Add this code:**

   ```typescript
   import Stripe from "stripe";

   if (!process.env.STRIPE_SECRET_KEY) {
     throw new Error("STRIPE_SECRET_KEY is not defined in .env file");
   }

   // Initialize Stripe
   export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
     apiVersion: "2024-11-20.acacia", // Latest API version
     typescript: true,
   });

   // Helper function: Convert dollars to cents
   // Stripe works in cents, so $10.00 = 1000 cents
   export const dollarsToCents = (dollars: number): number => {
     return Math.round(dollars * 100);
   };

   // Helper function: Convert cents to dollars
   export const centsToDollars = (cents: number): number => {
     return cents / 100;
   };

   // Log initialization
   console.log("âœ… Stripe initialized successfully");
   ```

3. **Save the file**

### Step 6.3: Update Database Models

**Add Stripe fields to Wallet model:**

1. **Open:** `src/db/models/wallet.model.ts`

2. **Find the interface and add these fields:**

   ```typescript
   export interface IWallet {
     user: Types.ObjectId;
     balance: number;
     escrowBalance: number;
     currency: string;
     isActive: boolean;
     isFrozen: boolean;
     totalEarnings: number;
     totalSpent: number;
     totalWithdrawals: number;

     // NEW: Stripe fields
     stripeCustomerId?: string; // For customer deposits
     stripeConnectAccountId?: string; // For contractor payouts
     stripeConnectOnboarded?: boolean; // Has contractor completed KYC?

     createdAt: Date;
     updatedAt: Date;
   }
   ```

3. **Update the schema:**

   ```typescript
   const walletSchema = new Schema<IWallet>(
     {
       // ... existing fields ...

       // Add these new fields
       stripeCustomerId: {
         type: String,
         index: true,
         sparse: true,
       },
       stripeConnectAccountId: {
         type: String,
         index: true,
         sparse: true,
       },
       stripeConnectOnboarded: {
         type: Boolean,
         default: false,
       },
     },
     { timestamps: true }
   );
   ```

4. **Save the file**

**Add Stripe fields to Transaction model:**

1. **Open:** `src/db/models/transaction.model.ts`

2. **Add these fields to the interface:**

   ```typescript
   export interface ITransaction {
     // ... existing fields ...

     // NEW: Stripe fields
     stripePaymentIntentId?: string; // Links to Stripe payment
     stripeTransferId?: string; // Links to Stripe transfer
     stripeRefundId?: string; // Links to Stripe refund
     stripeChargeId?: string; // Links to Stripe charge
   }
   ```

3. **Update the schema:**

   ```typescript
   const transactionSchema = new Schema<ITransaction>(
     {
       // ... existing fields ...

       // Add these new fields
       stripePaymentIntentId: {
         type: String,
         index: true,
         sparse: true,
       },
       stripeTransferId: {
         type: String,
         index: true,
         sparse: true,
       },
       stripeRefundId: {
         type: String,
         index: true,
         sparse: true,
       },
       stripeChargeId: {
         type: String,
         index: true,
         sparse: true,
       },
     },
     { timestamps: true }
   );
   ```

4. **Save the file**

### Step 6.4: Verify Your .env File

**Open `.env` and make sure you have all these:**

```env
# Database
DATABASE_URL=your_mongodb_connection_string

# JWT
JWT_SECRET=your_jwt_secret
ACCESS_SECRET=your_access_secret
REFRESH_SECRET=your_refresh_secret

# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_your_secret_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_publishable_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
STRIPE_CONNECT_CLIENT_ID=ca_your_client_id_here

# Payment Settings
PAYMENT_CURRENCY=usd
PLATFORM_NAME=JobSphere
PLATFORM_EMAIL=support@jobsphere.com

# URLs
FRONTEND_URL=http://localhost:3000
API_BASE_URL=http://localhost:4000

# Admin (optional)
ADMIN_USER_ID=your_admin_user_id_if_you_have_one
```

**Save the file**

---

## Part 7: Testing Your Integration

### Step 7.1: Start Your Development Environment

1. **Terminal 1 - Start Backend:**

   ```bash
   cd C:\Yeasin\office\thasporesai-backend-jvai
   bun dev
   ```

2. **Terminal 2 - Start Stripe Webhook Forwarding:**

   ```bash
   stripe listen --forward-to localhost:4000/api/webhooks/stripe
   ```

3. **Keep both terminals running**

### Step 7.2: Test Deposit Flow

**You'll need an API testing tool like Postman or Insomnia.**

**Test 1: Create a Deposit**

1. **Login as a customer** (get your JWT token)

   ```
   POST http://localhost:4000/api/auth/login
   Body: {
     "email": "customer@test.com",
     "password": "password123"
   }
   ```

2. **Copy the access token from response**

3. **Make a deposit request:**

   ```
   POST http://localhost:4000/api/wallet/deposit
   Headers: {
     "Authorization": "Bearer YOUR_ACCESS_TOKEN",
     "Content-Type": "application/json"
   }
   Body: {
     "amount": 100,
     "paymentMethodId": "pm_card_visa"
   }
   ```

   **Note:** `pm_card_visa` is a test payment method that always succeeds

4. **Check the response:**

   ```json
   {
     "status": 200,
     "message": "Deposit initiated",
     "data": {
       "paymentIntent": {
         "id": "pi_xxxxx",
         "status": "succeeded",
         "amount": 100
       },
       "transaction": { ... },
       "message": "Payment processing. Balance will update upon confirmation."
     }
   }
   ```

5. **Check Terminal 2 (Stripe CLI)**

   You should see:

   ```
   2025-11-25 10:30:45  --> payment_intent.succeeded [evt_xxxxx]
   ```

6. **Check Terminal 1 (Backend)**

   You should see:

   ```
   âœ… Received webhook: payment_intent.succeeded [evt_xxxxx]
   âœ… Deposit completed: $100 for user user123
   ```

7. **Check wallet balance:**

   ```
   GET http://localhost:4000/api/wallet
   Headers: {
     "Authorization": "Bearer YOUR_ACCESS_TOKEN"
   }
   ```

   Response should show:

   ```json
   {
     "balance": 100,
     "escrowBalance": 0
   }
   ```

**âœ… If you see the balance updated, deposits are working!**

### Step 7.3: Test Cards

Stripe provides test cards for different scenarios:

**Successful Payments:**

```
Card: 4242 4242 4242 4242
Expiry: Any future date (e.g., 12/25)
CVC: Any 3 digits (e.g., 123)
ZIP: Any 5 digits (e.g., 12345)
```

**Declined Card:**

```
Card: 4000 0000 0000 0002
```

**Insufficient Funds:**

```
Card: 4000 0000 0000 9995
```

**Expired Card:**

```
Card: 4000 0000 0000 0069
```

**Test these different scenarios to see how your system handles them!**

### Step 7.4: Test Contractor Connect Flow

**Test 1: Create Connect Account**

1. **Login as a contractor**

2. **Create Connect account:**

   ```
   POST http://localhost:4000/api/wallet/connect
   Headers: {
     "Authorization": "Bearer CONTRACTOR_ACCESS_TOKEN"
   }
   ```

3. **Response will include:**

   ```json
   {
     "accountId": "acct_xxxxx",
     "onboardingUrl": "https://connect.stripe.com/setup/..."
   }
   ```

4. **Open the `onboardingUrl` in browser**

   - You'll see Stripe's onboarding form
   - Fill in test information
   - Use test SSN: `000-00-0000`
   - Use test bank account: Routing `110000000`, Account `000123456789`

5. **Complete onboarding**

6. **Check Connect status:**

   ```
   GET http://localhost:4000/api/wallet/connect/status
   Headers: {
     "Authorization": "Bearer CONTRACTOR_ACCESS_TOKEN"
   }
   ```

   Response:

   ```json
   {
     "connected": true,
     "onboarded": true,
     "accountId": "acct_xxxxx"
   }
   ```

**âœ… If onboarded is true, Connect is working!**

### Step 7.5: Test Withdrawal Flow

**Prerequisites:**

- Contractor must have completed Connect onboarding
- Contractor must have balance in wallet

**Test 1: Withdraw Money**

1. **First, give contractor some balance** (as admin or through completed job)

2. **Make withdrawal request:**

   ```
   POST http://localhost:4000/api/wallet/withdraw
   Headers: {
     "Authorization": "Bearer CONTRACTOR_ACCESS_TOKEN"
   }
   Body: {
     "amount": 50
   }
   ```

3. **Check response:**

   ```json
   {
     "status": 200,
     "message": "Withdrawal initiated",
     "data": {
       "amount": 50,
       "newBalance": 30,
       "transferId": "tr_xxxxx",
       "estimatedArrival": "2-3 business days"
     }
   }
   ```

4. **Check Stripe CLI (Terminal 2)**

   You should see:

   ```
   --> transfer.paid [evt_xxxxx]
   ```

5. **Check backend logs (Terminal 1)**
   ```
   âœ… Withdrawal completed: $50 for user user456
   ```

**âœ… If you see this, withdrawals are working!**

---

## Part 8: Understanding How Money Flows

### The Complete Money Flow

Let me explain exactly how real money moves in your system:

### Scenario: Customer Hires Contractor for $100 Job

**Step 1: Customer Deposits Money**

```
Customer's Credit Card
    â†“ (Stripe charges $200)
Stripe Account (Your platform's Stripe balance)
    â†“ (Webhook confirms)
Customer's Wallet in Database (balance: $200)
```

**Real Money Location:** In your Stripe account

**Step 2: Customer Sends Offer ($100 job)**

```
Customer's Wallet: $200
    â†“ (Charge $105: $100 job + $5 platform fee)
Customer's Wallet: $95 available, $105 escrow
```

**Real Money Location:** Still in your Stripe account (just tracked differently in database)

**Step 3: Contractor Accepts Offer**

```
Escrow: $105
    â†“ (Transfer $5 platform fee to admin)
Admin Wallet: $5
Escrow: $100 (remaining)
```

**Real Money Location:** Still in your Stripe account

**Step 4: Job Completed**

```
Escrow: $100
    â†“ (Split payment)
Admin Wallet: +$20 (service fee)
Contractor Wallet: +$80 (payout)
Escrow: $0
```

**Real Money Location:** Still in your Stripe account

**Step 5: Contractor Withdraws**

```
Contractor Wallet: $80
    â†“ (Stripe Transfer)
Contractor's Bank Account: $80
Contractor Wallet: $0
```

**Real Money Location:** Moved from your Stripe account to contractor's bank account

### Where is the Real Money?

**In Your Stripe Account:**

- Customer deposits
- Platform fees (5%)
- Service fees (20%)
- Pending contractor payouts

**In Contractor's Bank Account:**

- After they withdraw (80% of job amount)

**In Your Business Bank Account:**

- When you transfer from Stripe to your bank (your profit: 25% commission)

### Stripe Balance vs Database Balance

**Important Concept:**

Your database tracks "who owns what money" but the actual money is in Stripe.

**Example:**

```
Stripe Balance: $1,000 (real money)

Database shows:
- Customer A wallet: $200
- Customer B wallet: $300
- Contractor C wallet: $150
- Contractor D wallet: $100
- Admin wallet: $250
Total: $1,000 âœ… (matches Stripe)
```

**Your database is like a ledger** - it tracks who owns what portion of the money in Stripe.

### Commission Breakdown (Visual)

For a $100 job:

```
Customer Pays: $105
    â”œâ”€ Platform Fee (5%): $5 â†’ Admin (on acceptance)
    â””â”€ Job Amount: $100 â†’ Escrow
                      â”œâ”€ Service Fee (20%): $20 â†’ Admin (on completion)
                      â””â”€ Contractor Payout (80%): $80 â†’ Contractor (on completion)

Admin Total: $25 (5% + 20%)
Contractor Gets: $80
```

---

## Part 9: Going Live (Production)

### When You're Ready for Production

**Prerequisites:**

- âœ… Tested thoroughly in test mode
- âœ… All features working correctly
- âœ… Error handling implemented
- âœ… Security reviewed
- âœ… Business verified with Stripe

### Step 9.1: Activate Your Stripe Account

1. **Complete Business Verification**

   - Go to Stripe Dashboard â†’ Settings â†’ Account
   - Click "Activate account"
   - Provide required information:
     - Business details
     - Bank account for payouts
     - Tax information
     - Identity verification

2. **Wait for Approval**
   - Usually takes 1-2 business days
   - Stripe may request additional documents
   - Check your email for updates

### Step 9.2: Get Live API Keys

1. **Switch to Live Mode**

   - Toggle "Test mode" OFF in Stripe Dashboard
   - You'll now see live data

2. **Get Live API Keys**

   - Go to Developers â†’ API keys
   - Copy your live keys:
     - `pk_live_xxxxx` (Publishable key)
     - `sk_live_xxxxx` (Secret key)

3. **Update Production Environment**
   - In your production server (not local `.env`)
   - Update these variables:
     ```env
     STRIPE_SECRET_KEY=sk_live_xxxxx
     STRIPE_PUBLISHABLE_KEY=pk_live_xxxxx
     ```

### Step 9.3: Setup Production Webhooks

1. **Go to Developers â†’ Webhooks**

2. **Click "Add endpoint"**

3. **Enter your production URL:**

   ```
   https://api.yourdomain.com/api/webhooks/stripe
   ```

4. **Select events to listen for:**

   - âœ… `payment_intent.succeeded`
   - âœ… `payment_intent.payment_failed`
   - âœ… `transfer.paid`
   - âœ… `transfer.failed`
   - âœ… `charge.refunded`
   - âœ… `account.updated` (for Connect)

5. **Click "Add endpoint"**

6. **Copy the webhook signing secret**
   - It starts with `whsec_`
   - Add to production environment:
     ```env
     STRIPE_WEBHOOK_SECRET=whsec_xxxxx
     ```

### Step 9.4: Update Connect Settings

1. **Go to Connect â†’ Settings**

2. **Update redirect URLs to production:**

   ```
   Success URL: https://yourdomain.com/connect/success
   Failure URL: https://yourdomain.com/connect/failure
   Refresh URL: https://yourdomain.com/connect/refresh
   ```

3. **Save changes**

### Step 9.5: Test with Real Money (Small Amounts)

**Before full launch:**

1. **Test with your own card**

   - Deposit $10
   - Verify it appears in Stripe Dashboard
   - Verify balance updates in your app

2. **Test withdrawal**

   - Connect your own bank account
   - Withdraw $5
   - Verify it arrives in 2-3 days

3. **Test refund**

   - Issue a refund
   - Verify it processes correctly

4. **Monitor closely**
   - Check Stripe Dashboard regularly
   - Review webhook logs
   - Monitor error rates

### Step 9.6: Launch Checklist

Before going live:

**Technical:**

- [ ] All API keys updated to live mode
- [ ] Webhooks configured and tested
- [ ] SSL certificate installed (HTTPS)
- [ ] Error monitoring setup
- [ ] Logging configured
- [ ] Database backups enabled

**Business:**

- [ ] Terms of Service updated
- [ ] Privacy Policy includes payment info
- [ ] Refund policy defined
- [ ] Customer support ready
- [ ] Stripe account fully activated

**Testing:**

- [ ] Deposit tested with real card
- [ ] Withdrawal tested with real bank
- [ ] Refund tested
- [ ] Error scenarios tested
- [ ] Webhook delivery verified

**Security:**

- [ ] API keys secured
- [ ] Webhook signature verification enabled
- [ ] Rate limiting implemented
- [ ] Fraud detection reviewed
- [ ] PCI compliance confirmed

---

## Troubleshooting Common Issues

### Issue 1: "Stripe is not defined"

**Error:**

```
ReferenceError: stripe is not defined
```

**Solution:**

1. Make sure you created `src/lib/stripe.ts`
2. Import it in your service files:
   ```typescript
   import { stripe } from "@/lib/stripe";
   ```

### Issue 2: "Invalid API Key"

**Error:**

```
Error: Invalid API Key provided
```

**Solution:**

1. Check your `.env` file has the correct key
2. Make sure it starts with `sk_test_` (test) or `sk_live_` (production)
3. Restart your server after updating `.env`

### Issue 3: Webhook Not Received

**Symptoms:**

- Deposit stays pending
- Balance doesn't update

**Solution:**

1. Check Stripe CLI is running: `stripe listen --forward-to localhost:4000/api/webhooks/stripe`
2. Check webhook secret in `.env` matches CLI output
3. Check your backend is running
4. Check webhook route is registered before `express.json()` middleware

### Issue 4: "No such customer"

**Error:**

```
Error: No such customer: 'cus_xxxxx'
```

**Solution:**

1. Customer ID might be from test mode but you're in live mode (or vice versa)
2. Make sure you're in the correct mode (test/live)
3. Check `stripeCustomerId` in database matches Stripe Dashboard

### Issue 5: Connect Onboarding Fails

**Symptoms:**

- Contractor can't complete onboarding
- Gets error on Stripe page

**Solution:**

1. Check Connect is enabled in Dashboard
2. Verify redirect URLs are correct
3. Make sure contractor is in supported country
4. Check Stripe Dashboard â†’ Connect â†’ Accounts for error details

### Issue 6: Withdrawal Fails

**Error:**

```
Error: No such destination
```

**Solution:**

1. Contractor must complete Connect onboarding first
2. Check `stripeConnectAccountId` exists in database
3. Check `stripeConnectOnboarded` is true
4. Verify account in Stripe Dashboard â†’ Connect â†’ Accounts

### Issue 7: Amount Mismatch

**Symptoms:**

- Charged $1 instead of $100

**Solution:**

- Stripe uses cents, not dollars
- Always use `dollarsToCents()` helper:
  ```typescript
  amount: dollarsToCents(100); // Correct: 10000 cents
  amount: 100; // Wrong: charges $1.00
  ```

---

## Quick Reference

### Test Cards

```
Success: 4242 4242 4242 4242
Declined: 4000 0000 0000 0002
Insufficient Funds: 4000 0000 0000 9995
Expired: 4000 0000 0000 0069

Expiry: Any future date
CVC: Any 3 digits
ZIP: Any 5 digits
```

### Test Bank Account (Connect)

```
Routing Number: 110000000
Account Number: 000123456789
SSN: 000-00-0000
```

### Important URLs

```
Stripe Dashboard: https://dashboard.stripe.com
Stripe Docs: https://stripe.com/docs
Stripe CLI: https://stripe.com/docs/stripe-cli
API Reference: https://stripe.com/docs/api
```

### Key Commands

```bash
# Login to Stripe CLI
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:4000/api/webhooks/stripe

# Trigger test webhook
stripe trigger payment_intent.succeeded

# View Stripe logs
stripe logs tail

# Test API call
stripe charges list --limit 10
```

### Environment Variables Checklist

```env
âœ… STRIPE_SECRET_KEY=sk_test_xxxxx
âœ… STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
âœ… STRIPE_WEBHOOK_SECRET=whsec_xxxxx
âœ… STRIPE_CONNECT_CLIENT_ID=ca_xxxxx
âœ… PAYMENT_CURRENCY=usd
âœ… PLATFORM_NAME=JobSphere
âœ… PLATFORM_EMAIL=support@jobsphere.com
âœ… FRONTEND_URL=http://localhost:3000
```

---

## Next Steps

### What You've Accomplished

âœ… Created Stripe account  
âœ… Got API keys  
âœ… Setup webhooks  
âœ… Enabled Stripe Connect  
âœ… Configured your project  
âœ… Tested deposits  
âœ… Tested withdrawals  
âœ… Understand money flow

### What to Do Next

1. **Implement Frontend**

   - Add Stripe.js to your frontend
   - Create deposit UI
   - Create Connect onboarding UI
   - Handle payment confirmations

2. **Add Error Handling**

   - Handle declined cards gracefully
   - Show user-friendly error messages
   - Implement retry logic
   - Add logging

3. **Implement Refunds**

   - Create refund service
   - Handle refund webhooks
   - Update wallet balances
   - Send notifications

4. **Add Monitoring**

   - Track payment success rate
   - Monitor webhook delivery
   - Set up alerts for failures
   - Review Stripe Dashboard daily

5. **Prepare for Production**
   - Complete business verification
   - Get live API keys
   - Setup production webhooks
   - Test with real money (small amounts)

---

## Getting Help

### Stripe Support

- **Documentation**: https://stripe.com/docs
- **Support Email**: support@stripe.com
- **Community**: https://stripe.com/community
- **Status Page**: https://status.stripe.com

### Your Project

- **Payment Documentation**: `doc/payment/`
- **Webhook Guide**: `doc/payment/STRIPE_WEBHOOK_GUIDE.md`
- **Integration Guide**: `doc/payment/MONEY/4.STRIPE_INTEGRATION_GUIDE.md`

### Common Questions

**Q: Is test mode free?**  
A: Yes! Test mode is completely free. No real money is charged.

**Q: When should I switch to live mode?**  
A: Only after thorough testing and business verification.

**Q: How long do payouts take?**  
A: Typically 2-3 business days for bank transfers.

**Q: What are Stripe's fees?**  
A: 2.9% + $0.30 per successful card charge in the US.

**Q: Can I test without a credit card?**  
A: Yes! Use test card numbers provided by Stripe.

**Q: Do I need PCI compliance?**  
A: No! Stripe handles PCI compliance for you.

---

## Conclusion

Congratulations! ðŸŽ‰

You now understand:

- âœ… What Stripe is and why you need it
- âœ… How to setup your Stripe account
- âœ… How to get API keys
- âœ… How to configure webhooks
- âœ… How to enable Stripe Connect
- âœ… How to integrate with your project
- âœ… How money flows through your system
- âœ… How to test everything
- âœ… How to go live

**Your JobSphere payment system is now ready to handle real money!**

Remember:

- Always test in test mode first
- Never commit API keys to git
- Monitor your Stripe Dashboard regularly
- Start with small amounts in production
- Keep learning from Stripe docs

**Good luck with your launch! ðŸš€**

---

**Document Version**: 1.0.0  
**Last Updated**: November 25, 2025  
**Status**: Complete Beginner's Guide  
**Estimated Reading Time**: 60 minutes  
**Hands-on Time**: 2-3 hours
