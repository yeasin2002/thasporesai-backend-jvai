# Stripe Integration Tasklist

**Version**: 1.0.0  
**Created**: January 24, 2026  
**Status**: ‚è≥ Pending Implementation
**creator**: Antigravity

---

## Overview

This tasklist covers all implementation tasks for integrating Stripe into the JobSphere payment system. Tasks are organized by phase and priority.

---

## Phase 1: Setup & Configuration

### 1.1 Stripe Account Setup

- [ ] Create Stripe account (or verify existing)
- [ ] Enable Stripe Connect for marketplace functionality
- [ ] Configure webhook endpoints in Stripe Dashboard
- [ ] Note API keys (publishable, secret, webhook secret)

### 1.2 Environment Configuration

- [ ] Add environment variables to `.env`:
  ```
  STRIPE_SECRET_KEY=sk_test_xxx
  STRIPE_PUBLISHABLE_KEY=pk_test_xxx
  STRIPE_WEBHOOK_SECRET=whsec_xxx
  STRIPE_CONNECT_CLIENT_ID=ca_xxx
  ```
- [ ] Add variables to `src/common/env-config.ts` validation schema
- [ ] Update `.env.example` with new variables

### 1.3 Package Installation

- [ ] Install Stripe SDK: `pnpm add stripe`
- [ ] Verify TypeScript types are included

### 1.4 Stripe Client Setup

- [ ] Create `src/common/stripe/stripe.client.ts`:
  ```typescript
  import Stripe from "stripe";
  export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);
  ```
- [ ] Export from `src/common/stripe/index.ts`

---

## Phase 2: Database Model Updates

### 2.1 User Model Updates

- [ ] Add Stripe fields to `src/db/models/user.model.ts`:
  - `stripeCustomerId: string` (for customers)
  - `stripeConnectAccountId: string` (for contractors)
  - `stripeOnboardingComplete: boolean`

### 2.2 Transaction Model Updates

- [ ] Add Stripe reference fields to `src/db/models/transaction.model.ts`:
  - `stripePaymentIntentId: string`
  - `stripeTransferId: string`
  - `stripePayoutId: string`

### 2.3 Wallet Model Updates (Optional)

- [ ] Consider adding `lastStripeSync: Date` for reconciliation

---

## Phase 3: Customer Deposits (Payment Intents)

### 3.1 Create Payment Intent Service

- [ ] Create `src/api/wallet/services/create-payment-intent.service.ts`
- [ ] Implement logic:
  1. Validate deposit amount (min $10)
  2. Get/create Stripe Customer for user
  3. Create PaymentIntent with amount, currency, customer
  4. Return `clientSecret` to frontend
- [ ] Add route: `POST /api/wallet/deposit/create-intent`

### 3.2 Update Deposit Service

- [ ] Modify `src/api/wallet/services/deposit.service.ts`:
  - Remove manual balance update
  - Create pending transaction record
  - Return PaymentIntent details
- [ ] Add validation for `paymentIntentId` parameter

### 3.3 Stripe Customer Management

- [ ] Create `src/common/stripe/get-or-create-customer.ts`:
  1. Check if user has `stripeCustomerId`
  2. If not, create Stripe Customer
  3. Save `stripeCustomerId` to user
  4. Return customer ID

### 3.4 Frontend Integration Points

- [ ] Document: Frontend receives `clientSecret`
- [ ] Document: Frontend uses Stripe.js to confirm payment
- [ ] Document: Payment confirmation triggers webhook

---

## Phase 4: Contractor Withdrawals (Stripe Connect)

### 4.1 Connect Onboarding

- [ ] Create `src/api/wallet/services/create-connect-account.service.ts`:
  1. Create Express Connect account
  2. Generate onboarding link
  3. Save `stripeConnectAccountId` to user
- [ ] Add route: `POST /api/wallet/connect/onboard`
- [ ] Add route: `GET /api/wallet/connect/status`

### 4.2 Connect Account Link Generation

- [ ] Create `src/api/wallet/services/create-account-link.service.ts`:
  1. Generate account link for incomplete onboarding
  2. Return URL for frontend redirect

### 4.3 Update Withdraw Service

- [ ] Modify `src/api/wallet/services/withdraw.service.ts`:
  1. Verify contractor has completed Connect onboarding
  2. Verify Connect account is verified
  3. Create Stripe Transfer to Connect account
  4. Create pending transaction record
  5. Deduct from wallet balance
- [ ] Handle transfer failures gracefully

### 4.4 Payout Configuration

- [ ] Configure automatic payouts (or manual) per account
- [ ] Document payout schedule (daily, weekly, etc.)

---

## Phase 5: Webhook Implementation

### 5.1 Webhook Endpoint Setup

- [ ] Create `src/api/webhook/webhook.route.ts`
- [ ] Create `src/api/webhook/services/stripe-webhook.service.ts`
- [ ] Configure raw body parsing for webhook route
- [ ] Verify webhook signature using `stripe.webhooks.constructEvent()`

### 5.2 Payment Intent Webhooks

- [ ] Handle `payment_intent.succeeded`:
  1. Find pending transaction by PaymentIntent ID
  2. Update transaction status to `completed`
  3. Add amount to user wallet balance
  4. Send notification to user
- [ ] Handle `payment_intent.payment_failed`:
  1. Update transaction status to `failed`
  2. Record failure reason
  3. Send notification to user

### 5.3 Connect Webhooks

- [ ] Handle `account.updated`:
  1. Check if onboarding complete
  2. Update user `stripeOnboardingComplete`
- [ ] Handle `payout.paid`:
  1. Find transaction by payout ID
  2. Update transaction status
  3. Notify contractor
- [ ] Handle `payout.failed`:
  1. Update transaction status to `failed`
  2. Refund to wallet balance
  3. Notify contractor

### 5.4 Transfer Webhooks

- [ ] Handle `transfer.created`: Log transfer creation
- [ ] Handle `transfer.reversed`: Handle reversal/refund

---

## Phase 6: Route Updates

### 6.1 Wallet Routes

Update `src/api/wallet/wallet.route.ts`:

| Route                               | Method | Status    | Description                |
| ----------------------------------- | ------ | --------- | -------------------------- |
| `/api/wallet`                       | GET    | ‚úÖ Exists | Get wallet balance         |
| `/api/wallet/deposit`               | POST   | üîÑ Update | Update for Payment Intents |
| `/api/wallet/deposit/create-intent` | POST   | ‚è≥ New    | Create Payment Intent      |
| `/api/wallet/withdraw`              | POST   | üîÑ Update | Update for Connect payouts |
| `/api/wallet/transactions`          | GET    | ‚úÖ Exists | Transaction history        |
| `/api/wallet/connect/onboard`       | POST   | ‚è≥ New    | Start Connect onboarding   |
| `/api/wallet/connect/status`        | GET    | ‚è≥ New    | Check Connect status       |
| `/api/wallet/connect/link`          | GET    | ‚è≥ New    | Get onboarding link        |

### 6.2 Webhook Routes

Create `src/api/webhook/webhook.route.ts`:

| Route                 | Method | Status | Description            |
| --------------------- | ------ | ------ | ---------------------- |
| `/api/webhook/stripe` | POST   | ‚è≥ New | Stripe webhook handler |

### 6.3 No Changes Required

The following routes work with the existing escrow system and need **no Stripe changes**:

- `POST /api/offer/:offerId/accept` - Internal wallet transfer
- `POST /api/offer/:offerId/reject` - Internal refund
- `POST /api/job/:id/complete` - Internal payout
- `POST /api/job/:id/cancel` - Internal refund

---

## Phase 7: Validation & Error Handling

### 7.1 Validation Schemas

- [ ] Create `src/api/wallet/wallet.validation.ts` updates:
  - `CreatePaymentIntentSchema`: Validate amount
  - `ConfirmDepositSchema`: Validate paymentIntentId
  - `ConnectOnboardSchema`: No additional params needed

### 7.2 Error Handling

- [ ] Create `src/common/stripe/stripe-error-handler.ts`:
  - Handle `StripeCardError`
  - Handle `StripeInvalidRequestError`
  - Handle `StripeAPIError`
  - Handle `StripeConnectionError`
  - Handle `StripeAuthenticationError`
- [ ] Map Stripe errors to user-friendly messages

### 7.3 Retry Logic

- [ ] Implement idempotency keys for critical operations
- [ ] Add retry mechanism for transient failures

---

## Phase 8: Testing

### 8.1 Unit Tests

- [ ] Test Payment Intent creation
- [ ] Test Connect account creation
- [ ] Test webhook signature verification
- [ ] Test error handling

### 8.2 Integration Tests

- [ ] Test complete deposit flow (API ‚Üí Webhook)
- [ ] Test complete withdrawal flow (API ‚Üí Transfer ‚Üí Payout)
- [ ] Test Connect onboarding flow

### 8.3 Stripe CLI Testing

- [ ] Install Stripe CLI
- [ ] Forward webhooks locally: `stripe listen --forward-to localhost:3000/api/webhook/stripe`
- [ ] Trigger test events: `stripe trigger payment_intent.succeeded`

### 8.4 Test Cards

| Card Number      | Scenario                      |
| ---------------- | ----------------------------- |
| 4242424242424242 | Successful payment            |
| 4000000000009995 | Declined (insufficient funds) |
| 4000000000000002 | Declined (generic)            |
| 4000002500003155 | Requires 3D Secure            |

---

## Phase 9: Documentation

### 9.1 API Documentation

- [ ] Update OpenAPI specs for new endpoints
- [ ] Document request/response formats
- [ ] Add Stripe-specific error codes

### 9.2 Frontend Integration Guide

- [ ] Document Stripe.js setup
- [ ] Document Elements integration
- [ ] Document Connect onboarding flow
- [ ] Provide code examples (React/Flutter)

### 9.3 Deployment Guide

- [ ] Document production Stripe setup
- [ ] Document webhook URL configuration
- [ ] Document environment variables
- [ ] Document monitoring/logging

---

## Phase 10: Production Readiness

### 10.1 Security Checklist

- [ ] Webhook signature verification enabled
- [ ] API keys stored securely (env vars)
- [ ] No sensitive data logged
- [ ] HTTPS enforced for all Stripe communication

### 10.2 Monitoring

- [ ] Set up Stripe Dashboard alerts
- [ ] Log all webhook events
- [ ] Monitor failed transactions
- [ ] Set up error notifications

### 10.3 Go-Live Checklist

- [ ] Switch from test to live API keys
- [ ] Update webhook endpoints to production URLs
- [ ] Verify Connect accounts in production
- [ ] Test with real (small) transactions
- [ ] Enable fraud protection (Radar)

---

## Summary: Files to Create/Modify

### New Files

| File                                                        | Purpose                |
| ----------------------------------------------------------- | ---------------------- |
| `src/common/stripe/stripe.client.ts`                        | Stripe client instance |
| `src/common/stripe/get-or-create-customer.ts`               | Customer management    |
| `src/common/stripe/stripe-error-handler.ts`                 | Error handling         |
| `src/api/wallet/services/create-payment-intent.service.ts`  | Create Payment Intent  |
| `src/api/wallet/services/create-connect-account.service.ts` | Connect onboarding     |
| `src/api/wallet/services/create-account-link.service.ts`    | Onboarding link        |
| `src/api/webhook/webhook.route.ts`                          | Webhook routing        |
| `src/api/webhook/services/stripe-webhook.service.ts`        | Webhook handler        |

### Files to Modify

| File                                          | Changes                     |
| --------------------------------------------- | --------------------------- |
| `src/db/models/user.model.ts`                 | Add Stripe fields           |
| `src/db/models/transaction.model.ts`          | Add Stripe reference fields |
| `src/api/wallet/wallet.route.ts`              | Add new routes              |
| `src/api/wallet/services/deposit.service.ts`  | Update for Payment Intents  |
| `src/api/wallet/services/withdraw.service.ts` | Update for Connect          |
| `src/api/wallet/wallet.validation.ts`         | Add new schemas             |
| `src/common/env-config.ts`                    | Add Stripe env vars         |

---

## Estimated Timeline

| Phase                  | Duration | Priority    |
| ---------------------- | -------- | ----------- |
| Phase 1: Setup         | 2 hours  | üî¥ Critical |
| Phase 2: Database      | 1 hour   | üî¥ Critical |
| Phase 3: Deposits      | 4 hours  | üî¥ Critical |
| Phase 4: Withdrawals   | 6 hours  | üî¥ Critical |
| Phase 5: Webhooks      | 4 hours  | üî¥ Critical |
| Phase 6: Routes        | 2 hours  | üü° High     |
| Phase 7: Validation    | 2 hours  | üü° High     |
| Phase 8: Testing       | 4 hours  | üü° High     |
| Phase 9: Documentation | 2 hours  | üü¢ Medium   |
| Phase 10: Production   | 2 hours  | üü¢ Medium   |

**Total Estimated Time**: ~29 hours

---

**Next Step**: [5.STRIPE_IMPLEMENTATION_OVERVIEW.md](./5.STRIPE_IMPLEMENTATION_OVERVIEW.md) - Detailed implementation guide
