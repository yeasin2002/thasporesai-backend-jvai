# JobSphere Payment System - Complete Documentation

**Version**: 2.0.0  
**Last Updated**: January 28, 2026  
**Status**: ✅ Production Ready with Stripe Integration

---

## Table of Contents

1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Core Features](#core-features)
4. [Commission Structure](#commission-structure)
5. [Payment Flow](#payment-flow)
6. [API Endpoints](#api-endpoints)
7. [Integration Guide](#integration-guide)
8. [Data Models](#data-models)
9. [User Roles & Permissions](#user-roles--permissions)
10. [Error Handling](#error-handling)
11. [Security Features](#security-features)
12. [Testing Guide](#testing-guide)
13. [Deployment](#deployment)
14. [Support & Resources](#support--resources)

---

## Overview

The JobSphere Payment System is a comprehensive wallet-based payment platform designed for service marketplaces. It facilitates secure transactions between customers and contractors with automated commission handling, Stripe integration for real money transfers, and complete transaction tracking.

### Key Highlights

- **Stripe Integration**: Stripe Checkout for deposits (browser-based), Stripe Connect for admin-approved payouts
- **Wallet-Based Tracking**: Internal wallet system tracks all transactions in database (Stripe as "bank")
- **Minimal Real Money Transfers**: Only deposits and admin-approved payouts involve actual Stripe transfers
- **Simplified Balance System**: Single wallet balance (no escrow), all transactions via DB adjustments
- **One Offer Per Job**: Simplified workflow with single offer acceptance
- **Automatic Refunds**: Cancellations and rejections trigger instant DB wallet adjustments
- **Real-Time Updates**: WebSocket integration for instant notifications
- **Transaction History**: Complete audit trail of all financial activities
- **Admin-Approved Payouts**: All contractor payments require admin approval and Stripe Connect transfer

---

## System Architecture

### Core Components

The payment system consists of several interconnected modules:

**Wallet Management**

- Handles user balances (single balance tracked in database)
- Processes deposits via Stripe Checkout (browser-based, not in-app)
- Processes withdrawals via Stripe Connect (admin-approved)
- Tracks lifetime earnings and spending
- Supports wallet freeze functionality
- **No Escrow System**: All transactions via simple balance adjustments

**Stripe Integration**

- Stripe Checkout for customer deposits (returns URL for browser opening)
- Stripe Connect for contractor payouts (admin-initiated transfers only)
- Webhook handling for deposit confirmations
- **Stripe as Bank**: Minimal real money transfers, wallet tracks all transactions
- Secure payment processing with PCI compliance

**Offer System**

- Manages job offers between customers and contractors
- Enforces one-offer-per-job rule
- Handles offer acceptance and rejection via DB wallet adjustments only
- Implements automatic expiration (7 days) with automated refunds
- **No Real Money Movement**: All offer transactions via database balance updates

**Transaction Engine**

- Records all financial movements in database
- Supports multiple transaction types
- Maintains complete audit trail
- **Database-Only Tracking**: Real money transfers only for deposits and admin-approved payouts

**Job Payment Integration**

- Links jobs with payment processing
- Manages job status transitions
- Triggers payment releases via admin approval
- Handles cancellations and refunds via DB adjustments

**Admin Service**

- Auto-creates admin user and wallet
- Manages commission collection via DB adjustments
- Approves contractor payout requests
- Initiates Stripe Connect transfers for approved payouts
- Provides system-wide payment oversight

**Automated Jobs**

- Offer expiration cron job (runs hourly) with automatic DB refunds
- Automatic wallet adjustments for refunds
- Notification dispatch
- Application status reset

---

## Core Features

### 1. Wallet System

Each user has a dedicated wallet with a single balance:

**Available Balance**

- Money available for sending offers or withdrawal
- Updated on deposits, refunds, and payments received
- Protected from unauthorized access
- **No Escrow**: All transactions via simple balance adjustments

**Transaction History**

- Complete record of all wallet activities
- Filterable by transaction type
- Paginated for performance
- Includes sender and receiver details

**Deposit Functionality**

- Minimum deposit: $10
- Backend creates Stripe Checkout Session and returns URL
- Customer opens URL in default browser (not in-app)
- Customer completes payment on Stripe-hosted page
- Webhook confirms payment and updates wallet balance in database
- **Real Money Transfer**: Only time actual money moves to Stripe
- Transaction logging in database

**Withdrawal System** (Contractors Only)

- Minimum withdrawal: $10
- Maximum withdrawal: $10,000
- Contractor requests withdrawal via API
- Request creates pending withdrawal record
- Admin reviews request in admin dashboard
- Admin approves and initiates Stripe Connect transfer
- **Real Money Transfer**: Admin-initiated actual money movement from Stripe
- Estimated arrival: 2-3 business days
- Requires sufficient available balance
- Blocked if wallet is frozen

### 2. Offer Management

**Sending Offers** (Customer Only)

- Specify job amount, timeline, and description
- Automatic commission calculation
- **No Escrow Hold**: Balance validation only, no immediate deduction
- One offer per job enforcement
- Balance validation before processing

**Accepting Offers** (Contractor Only)

- Reviews offer details and earnings breakdown
- Accepts to start job
- **Database-Only Transaction**: Wallet balances updated immediately
  - Customer wallet: decreased by total charge ($105)
  - Admin wallet: increased by total charge ($105)
- **No Real Money Transfer**: Only database balance adjustments
- Updates job status to "assigned"
- Rejects other pending applications

**Rejecting Offers** (Contractor Only)

- Provides rejection reason
- **Database-Only Refund**: If offer was accepted, wallet balances reversed
  - Admin wallet: decreased by total charge
  - Customer wallet: increased by total charge (full refund)
- **No Real Money Transfer**: Only database balance adjustments
- Resets application status
- Allows customer to send new offer
- Sends notification to customer

**Automatic Expiration**

- Offers expire after 7 days
- Automated hourly cron job check
- **Database-Only Refund**: If offer was accepted, wallet balances reversed
  - Admin wallet: decreased by total charge
  - Customer wallet: increased by total charge (full refund)
- **No Real Money Transfer**: Only database balance adjustments
- Application status reset
- Notification sent
- Customer can send new offer

### 3. Job Payment Processing

**Job Status Flow**

- **Open**: Accepting applications
- **Assigned**: Offer accepted, contractor assigned
- **In Progress**: Work actively being performed
- **Completed**: Work finished, payment released
- **Cancelled**: Job cancelled, refunds processed

**Payment Release** (On Completion)

- Customer marks job as complete
- Creates pending completion request
- Admin reviews in admin dashboard
- Admin approves completion request
- Wallet balances updated:
  - Admin wallet decreased by contractor payout
  - Contractor wallet increased by contractor payout
- Admin initiates Stripe Connect transfer to contractor
- Transaction records created
- Notifications sent to all parties

**Job Cancellation**

- Available before completion
- Full refund to customer if offer exists
- Wallet balances reversed immediately:
  - Admin wallet decreased by total charge
  - Customer wallet increased by total charge
- Cancellation reason recorded
- Notifications to affected parties

### 4. Commission System

**Platform Fee (5%)**

- Charged when customer sends offer
- Transferred to admin when offer accepted
- Non-refundable after acceptance
- Covers platform operating costs

**Service Fee (20%)**

- Deducted from job amount
- Transferred to admin on job completion
- Applied to contractor payout calculation
- Covers transaction processing and support

**Total Admin Commission (25%)**

- Combined platform fee and service fee
- Distributed at different transaction stages
- Transparent calculation and display
- Auditable through transaction history

### 5. Notification System

**Real-Time Notifications** (WebSocket/Socket.IO)

- Offer received
- Offer accepted/rejected
- Payment released
- Offer expired
- Withdrawal processed

**Push Notifications** (FCM)

- Mobile app integration
- Critical payment events
- Configurable per user
- Device token management

---

## Commission Structure

### Calculation Breakdown

For a $100 job:

| Component               | Amount      | Recipient     | Timing           |
| ----------------------- | ----------- | ------------- | ---------------- |
| Job Budget              | $100.00     | N/A           | Initial          |
| Platform Fee (5%)       | $5.00       | Admin         | Offer Acceptance |
| Total Charge            | **$105.00** | Customer Pays | Offer Sent       |
| Service Fee (20%)       | $20.00      | Admin         | Job Completion   |
| Contractor Payout (80%) | **$80.00**  | Contractor    | Job Completion   |
| Admin Total (25%)       | $25.00      | Admin         | Combined         |

### Customer Perspective

- Posts job with $100 budget
- Pays $105 total (includes 5% platform fee)
- $105 held in escrow when offer sent
- $0 refunded if job completed
- $105 refunded if offer rejected or cancelled

### Contractor Perspective

- Sees $100 job offer
- Knows they'll receive $80 (after 20% service fee)
- Receives $80 on job completion
- Can withdraw earnings anytime
- Minimum withdrawal $10

### Admin Revenue

- Receives $5 when offer accepted (5% platform fee)
- Receives $20 when job completed (20% service fee)
- Total commission: $25 per $100 job (25%)
- Auto-transferred to admin wallet
- Tracked in transaction history

---

## Payment Flow

### Complete Transaction Journey

**Step 1: Customer Preparation**

- Customer registers and logs in
- Requests deposit via API
- Backend creates Stripe Checkout Session
- Backend returns Checkout Session URL
- Customer opens URL in default browser (not in-app)
- Customer completes payment on Stripe-hosted page
- Stripe sends webhook to backend
- Backend verifies webhook signature
- Backend updates wallet balance in database (e.g., +$200)
- Posts job with budget (e.g., $100)
- Waits for contractor applications

**Step 2: Contractor Application**

- Contractor finds job
- Submits application with message
- Application visible to customer
- Status: "pending"

**Step 3: Offer Creation**

- Customer reviews applications
- Selects preferred contractor
- Sends offer with amount, timeline, description
- System calculates commissions:
  - Job budget: $100
  - Platform fee: $5
  - Total charge: $105
  - Service fee: $20
  - Contractor payout: $80
- Offer status: "pending"
- No wallet changes yet (pending acceptance)

**Step 4: Offer Response**

**Option A: Acceptance**

- Contractor reviews offer
- Accepts offer
- Wallet balances updated immediately:
  - Customer wallet: $200 - $105 = $95
  - Admin wallet: +$105
- Job status changes to "assigned"
- Contractor assigned to job
- Other applications rejected automatically
- Notifications sent
- **Note**: No real money transferred to Stripe yet

**Option B: Rejection**

- Contractor reviews offer
- Provides rejection reason
- No wallet changes (offer was pending)
- Application status: "pending" (reset)
- Customer can send new offer
- Notification sent to customer

**Step 5: Work Execution**

- Contractor updates status to "in_progress"
- Performs work according to timeline
- Communicates with customer
- Prepares for completion

**Step 6: Job Completion**

- Customer marks job as complete
- Creates pending completion request
- Admin reviews request in admin dashboard
- Admin approves completion
- Wallet balances updated:
  - Admin wallet: $105 - $80 = $25 (keeps commission)
  - Contractor wallet: +$80
- Admin initiates Stripe Connect transfer to contractor ($80)
- Job status: "completed"
- Offer status: "completed"
- Transaction records created
- Notifications sent

**Step 7: Withdrawal (Contractor)**

- Contractor has $80 available
- Requests withdrawal via API (e.g., $50)
- System validates balance
- Creates pending withdrawal request
- Admin reviews in admin dashboard
- Admin approves withdrawal
- Admin initiates Stripe Connect transfer ($50)
- Contractor wallet: $80 - $50 = $30
- Estimated arrival: 2-3 business days
- Transaction recorded

### Alternative Flows

**Job Cancellation**

- Customer or admin cancels job
- Cancellation reason recorded
- If offer accepted: Wallet balances reversed
  - Admin wallet: $105 - $105 = $0
  - Customer wallet: $95 + $105 = $200 (full refund)
- Job status: "cancelled"
- Notification to contractor

**Offer Expiration**

- Offer reaches 7-day limit
- Automated job identifies expired offer
- If offer was accepted: Wallet balances reversed
  - Admin wallet decreased
  - Customer wallet increased (full refund)
- Application status reset
- Notification sent
- Customer can send new offer

---

## API Endpoints

### Authentication

All endpoints except public routes require JWT authentication via Bearer token:

```
Authorization: Bearer <access_token>
Content-Type: application/json
```

### Wallet Endpoints

#### Get Wallet Balance

```
GET /api/wallet
```

**Authentication**: Required  
**Returns**: User's wallet with available balance (tracked in database)

#### Deposit Money

```
POST /api/wallet/deposit
```

**Authentication**: Required  
**Body**: `amount` (number)  
**Validation**: Minimum $10  
**Returns**: Stripe Checkout Session URL
**Flow**:

1. Backend creates Stripe Checkout Session
2. Returns session URL to client
3. Client opens URL in default browser
4. Customer completes payment on Stripe
5. Stripe sends webhook to backend
6. Backend verifies webhook and updates wallet

#### Request Withdrawal

```
POST /api/wallet/withdraw
```

**Authentication**: Required (Contractors only)  
**Body**: `amount` (number)  
**Validation**: Min $10, Max $10,000, sufficient balance  
**Returns**: Withdrawal request confirmation
**Flow**:

1. Creates pending withdrawal request
2. Admin reviews in dashboard
3. Admin approves and initiates Stripe Connect transfer
4. Wallet balance updated after approval

#### Get Transaction History

```
GET /api/wallet/transactions
```

**Authentication**: Required  
**Query Parameters**: `page`, `limit`, `type` (optional)  
**Returns**: Paginated list of transactions

#### Stripe Webhook Handler

```
POST /api/webhooks/stripe
```

**Authentication**: Webhook signature verification  
**Headers**: `Stripe-Signature`  
**Body**: Stripe event payload  
**Handles**:

- `checkout.session.completed` - Updates wallet on successful deposit
- `checkout.session.async_payment_succeeded` - Handles delayed payments
- `checkout.session.async_payment_failed` - Handles failed payments

### Offer Endpoints

#### Send Offer

```
POST /api/job-request/:applicationId/send-offer
```

**Authentication**: Required (Customer only)  
**Body**: `amount` (number), `timeline` (string), `description` (string)  
**Validation**:

- Amount: $10-$10,000
- Timeline: 1-100 characters
- Description: 10-1000 characters  
  **Returns**: Offer details, wallet balance, commission breakdown

#### Accept Offer

```
POST /api/job-request/offer/:offerId/accept
```

**Authentication**: Required (Contractor only)  
**Returns**: Updated offer, job status, payment breakdown

#### Reject Offer

```
POST /api/job-request/offer/:offerId/reject
```

**Authentication**: Required (Contractor only)  
**Body**: `reason` (string, optional)  
**Returns**: Updated offer status, refund amount

### Job Endpoints

#### Update Job Status

```
PATCH /api/job/:id/status
```

**Authentication**: Required  
**Body**: `status` (string)  
**Valid Transitions**:

- open → assigned, cancelled
- assigned → in_progress, cancelled
- in_progress → completed, cancelled  
  **Returns**: Updated job details

#### Complete Job

```
POST /api/job/:id/complete
```

**Authentication**: Required (Customer only)  
**Prerequisites**: Job must be "in_progress"  
**Returns**: Completed job details, pending admin approval
**Flow**:

1. Creates completion request
2. Admin reviews in dashboard
3. Admin approves completion
4. Wallet balances updated
5. Admin initiates Stripe Connect transfer to contractor

#### Cancel Job

```
POST /api/job/:id/cancel
```

**Authentication**: Required (Customer or Admin)  
**Body**: `reason` (string, optional)  
**Returns**: Cancelled job details, refund amount

---

## Integration Guide

### Frontend Integration (React/Next.js)

**Service Setup**

- Create service classes for wallet, offers, and jobs
- Implement centralized API client with interceptors
- Handle authentication tokens securely
- Add error handling middleware

**Wallet Integration**

- Display available and escrow balances prominently
- Show deposit and withdrawal options
- Implement transaction history view with filtering
- Add balance refresh on navigation

**Offer Flow UI**

- Create offer dialog with commission breakdown
- Show real-time balance validation
- Display contractor earnings calculation
- Add confirmation steps

**Job Management**

- Implement status badges with color coding
- Add complete/cancel buttons based on role
- Show payment status in job details
- Handle status transitions with confirmation

**Error Handling**

- Display user-friendly error messages
- Handle insufficient balance gracefully
- Show loading states during transactions
- Implement retry mechanisms

**Real-Time Updates**

- Integrate Socket.IO client
- Listen for payment events
- Update UI on notifications
- Show toast/snackbar for events

### Mobile Integration (Flutter)

**Service Layer**

- Create Dart service classes
- Use http package for API calls
- Implement secure token storage (flutter_secure_storage)
- Add error handling and retries

**Wallet Features**

- Design wallet widget with balance display
- Implement deposit flow:
  1. Call backend API to get Stripe Checkout URL
  2. Open URL in default browser using `url_launcher` package
  3. Listen for webhook confirmation (via polling or push notification)
  4. Refresh wallet balance after successful payment
- Add withdrawal request screens
- Show transaction history with pagination

**Stripe Checkout Integration**

- Use `url_launcher` package to open Stripe Checkout URL
- Example:

  ```dart
  import 'package:url_launcher/url_launcher.dart';

  Future<void> openStripeCheckout(String checkoutUrl) async {
    final Uri url = Uri.parse(checkoutUrl);
    if (await canLaunchUrl(url)) {
      await launchUrl(url, mode: LaunchMode.externalApplication);
    }
  }
  ```

- After payment, user returns to app
- App polls backend or receives push notification
- Refresh wallet balance

**Offer Management**

- Create offer cards with expandable details
- Implement accept/reject dialogs
- Show commission breakdown clearly
- Add confirmation flows

**Push Notifications**

- Integrate Firebase Cloud Messaging (FCM)
- Register device token with backend
- Handle notification payloads
- Navigate to relevant screens on tap
- Listen for payment confirmation notifications

**Offline Support**

- Cache wallet balance locally
- Queue transactions when offline
- Sync on reconnection
- Show sync status to user

**UI Components**

- Design custom wallet widget
- Create offer status badges
- Build transaction list items
- Implement pull-to-refresh

---

## Data Models

### Wallet Model

Represents user's financial account:

**Fields**:

- `_id`: Unique identifier
- `user`: Reference to user document
- `balance`: Available funds (tracked in database, not synced with Stripe)
- `currency`: Currency code (default: "USD")
- `isActive`: Account active status
- `isFrozen`: Account frozen status (prevents transactions)
- `totalEarnings`: Lifetime earnings
- `totalSpent`: Lifetime spending
- `totalWithdrawals`: Lifetime withdrawals
- `stripeCustomerId`: Stripe Customer ID (for deposits)
- `stripeConnectAccountId`: Stripe Connect Account ID (for payouts, contractors only)
- `createdAt`: Account creation timestamp
- `updatedAt`: Last update timestamp

**Note**: The `escrowBalance` field has been removed. All balance tracking is now done via the single `balance` field.

### Offer Model

Represents job offer between customer and contractor:

**Fields**:

- `_id`: Unique identifier
- `job`: Reference to job document
- `customer`: Reference to customer user
- `contractor`: Reference to contractor user
- `application`: Reference to application document
- `amount`: Job budget amount
- `platformFee`: 5% platform fee
- `serviceFee`: 20% service fee
- `contractorPayout`: 80% contractor payment
- `totalCharge`: Total amount charged to customer
- `timeline`: Expected completion timeline
- `description`: Work description
- `status`: Current status (pending, accepted, rejected, cancelled, completed, expired)
- `acceptedAt`: Acceptance timestamp
- `rejectedAt`: Rejection timestamp
- `cancelledAt`: Cancellation timestamp
- `completedAt`: Completion timestamp
- `expiresAt`: Expiration timestamp (7 days from creation)
- `rejectionReason`: Reason for rejection
- `cancellationReason`: Reason for cancellation
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp

### Transaction Model

Records all financial movements:

**Fields**:

- `_id`: Unique identifier
- `type`: Transaction type
  - `deposit`: Money added to wallet (via Stripe)
  - `withdrawal`: Money withdrawn (via Stripe Connect)
  - `wallet_transfer`: Money moved between wallets (internal)
  - `platform_fee`: Platform fee payment (wallet adjustment)
  - `service_fee`: Service fee payment (wallet adjustment)
  - `contractor_payout`: Payment to contractor (wallet adjustment + Stripe transfer)
  - `refund`: Refund to customer (wallet adjustment)
- `amount`: Transaction amount
- `from`: Sender user (populated)
- `to`: Receiver user (populated)
- `offer`: Reference to related offer
- `job`: Reference to related job
- `status`: Transaction status (pending, completed, failed)
- `description`: Transaction description
- `failureReason`: Reason for failure
- `stripePaymentIntentId`: Stripe Payment Intent ID (for deposits)
- `stripeTransferId`: Stripe Transfer ID (for payouts)
- `stripeCheckoutSessionId`: Stripe Checkout Session ID (for deposits)
- `completedAt`: Completion timestamp
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp

### Job Model

Extended with payment fields:

**Payment-Related Fields**:

- `contractorId`: Assigned contractor reference
- `offerId`: Accepted offer reference
- `status`: Job status (open, assigned, in_progress, completed, cancelled)
- `assignedAt`: Assignment timestamp
- `completedAt`: Completion timestamp
- `cancelledAt`: Cancellation timestamp
- `cancellationReason`: Reason for cancellation

---

## User Roles & Permissions

### Customer

**Allowed Actions**:

- Deposit money into wallet (via Stripe Checkout)
- Send offers to contractors
- Mark jobs as complete (creates pending request for admin)
- Cancel jobs before completion
- View transaction history
- View wallet balance

**Restrictions**:

- Cannot withdraw money
- Cannot accept their own offers
- Cannot update job status to "in_progress"

### Contractor

**Allowed Actions**:

- Accept or reject offers
- Update job status to "in_progress"
- Request withdrawal from wallet (creates pending request)
- View transaction history
- View wallet balance

**Restrictions**:

- Cannot send offers
- Cannot mark jobs as complete
- Cannot cancel jobs (only customer/admin can)
- Cannot directly withdraw (requires admin approval)

### Admin

**Allowed Actions**:

- Receive platform fees and service fees (wallet adjustments)
- Approve job completion requests
- Initiate Stripe Connect transfers to contractors
- Approve contractor withdrawal requests
- Initiate Stripe Connect transfers for withdrawals
- Cancel jobs on behalf of users
- View all transactions
- Freeze wallets if needed
- Override system restrictions

**Automatic Functions**:

- Admin user auto-created on first run
- Admin wallet auto-created
- Commission wallet adjustments automatic
- Stripe transfers require manual approval

---

## Error Handling

### Common Error Codes

| Code | Status       | Meaning                                 |
| ---- | ------------ | --------------------------------------- |
| 400  | Bad Request  | Invalid input or validation failed      |
| 401  | Unauthorized | Missing or invalid authentication token |
| 403  | Forbidden    | Insufficient permissions for action     |
| 404  | Not Found    | Requested resource doesn't exist        |
| 500  | Server Error | Internal server error occurred          |

### Error Response Format

All errors follow consistent structure:

```json
{
  "status": 400,
  "message": "Human-readable error description",
  "data": null,
  "errors": [
    {
      "field": "amount",
      "message": "Amount must be at least $10"
    }
  ]
}
```

### Wallet Errors

- **Insufficient balance**: Not enough available funds
- **Wallet not found**: User wallet doesn't exist (auto-creates)
- **Minimum deposit**: Deposit below $10
- **Maximum withdrawal**: Withdrawal above $10,000
- **Wallet frozen**: Account locked by admin
- **Contractor only**: Non-contractors attempting withdrawal

### Offer Errors

- **Offer already exists**: One offer per job rule violation
- **Job not open**: Job already assigned or completed
- **Insufficient balance**: Not enough for total charge
- **Not authorized**: User doesn't own resource
- **Offer expired**: Offer past 7-day expiration
- **Invalid status**: Offer in wrong status for action

### Job Errors

- **Job not found**: Invalid job ID
- **Invalid status transition**: Illegal status change
- **Cannot cancel completed**: Completed jobs immutable
- **No contractor assigned**: Required contractor missing
- **Not in progress**: Job must be in progress for completion

---

## Security Features

### Authentication & Authorization

**JWT Token System**

- Access tokens valid for 15 days (development)
- Refresh tokens valid for 30 days
- Tokens include user ID and role
- Validated on every protected endpoint

**Role-Based Access Control**

- Customer-only endpoints (send offer, complete job, cancel)
- Contractor-only endpoints (accept/reject offer, withdraw)
- Admin endpoints (override actions, freeze wallets)
- Automatic role verification via middleware

### Input Validation

**Zod Schema Validation**

- All inputs validated before processing
- Type checking and constraints enforced
- Custom error messages for clarity
- Prevents injection attacks

**Amount Validation**

- Positive numbers only
- Minimum and maximum limits
- Decimal precision controlled
- Currency format validated

**String Validation**

- Length constraints enforced
- Character set restrictions
- SQL injection prevention
- XSS protection

### Transaction Security

**Balance Verification**

- Pre-transaction balance check
- Atomic balance updates
- Race condition prevention
- Rollback on failures

**Escrow Protection**

- Funds held securely until completion
- Cannot be accessed during hold
- Automatic release on completion/cancellation
- Separate from available balance

**Audit Trail**

- Every transaction recorded
- Immutable transaction history
- Sender and receiver tracked
- Timestamps for all events

### Wallet Security

**Freeze Functionality**

- Admin can freeze suspicious wallets
- Prevents all transactions when frozen
- User notified of freeze
- Requires admin intervention to unfreeze

**Withdrawal Limits**

- Minimum: $10
- Maximum: $10,000 per transaction
- Prevents money laundering
- Configurable per system needs

---

## Testing Guide

### Manual Testing Flow

**Prerequisites**

- Create test customer account
- Create test contractor account
- Obtain authentication tokens
- Set up API testing tool (Postman/Insomnia)

**Test Scenario 1: Happy Path**

1. Customer deposits $200
   - Verify wallet balance updated
   - Check transaction created

2. Customer posts job
   - Verify job created with "open" status

3. Contractor applies to job
   - Verify application created

4. Customer sends $100 offer
   - Verify wallet deducted $105
   - Check escrow balance increased
   - Confirm offer created with pending status

5. Contractor accepts offer
   - Verify job status "assigned"
   - Check platform fee ($5) transferred to admin
   - Confirm other applications rejected

6. Contractor updates to "in_progress"
   - Verify job status updated

7. Customer marks complete
   - Verify service fee ($20) to admin
   - Check contractor receives $80
   - Confirm job status "completed"

8. Contractor withdraws $50
   - Verify balance decreased
   - Check transaction created

**Test Scenario 2: Offer Rejection**

1-4. Same as Happy Path

5. Contractor rejects offer
   - Verify full refund ($105) to customer
   - Check application status reset
   - Confirm notification sent

6. Customer sends new offer
   - Verify process repeats

**Test Scenario 3: Job Cancellation**

1-6. Same as Happy Path

7. Customer cancels job
   - Verify refund processed
   - Check escrow released
   - Confirm job status "cancelled"

**Test Scenario 4: Insufficient Balance**

1. Customer deposits $50

2-3. Same as Happy Path

4. Customer attempts $100 offer
   - Verify error: "Insufficient balance"
   - Check wallet unchanged
   - Confirm no offer created

**Test Scenario 5: Offer Expiration**

1-4. Same as Happy Path

5. Wait for automated job to run (or manually trigger)
   - Verify offer status "expired"
   - Check full refund to customer
   - Confirm application reset

### API Response Validation

**Success Responses**

- Status code 200 or 201
- Consistent response structure
- All required fields present
- Correct data types

**Error Responses**

- Appropriate status codes
- Clear error messages
- Error details when applicable
- Consistent format

### Performance Testing

**Response Times**

- Wallet operations: < 500ms
- Offer operations: < 1000ms
- Transaction queries: < 2000ms
- Job operations: < 1000ms

**Concurrency**

- Multiple simultaneous offers
- Parallel wallet operations
- Concurrent job updates
- Race condition handling

---

## Deployment

### Environment Configuration

**Required Variables**

```
ADMIN_USER_ID=<optional_admin_id>
DATABASE_URL=<mongodb_connection_string>
JWT_SECRET=<secret_key>
STRIPE_SECRET_KEY=<stripe_secret_key>
STRIPE_PUBLISHABLE_KEY=<stripe_publishable_key>
STRIPE_WEBHOOK_SECRET=<webhook_secret>
```

**Optional Variables**

```
FCM_SERVER_KEY=<firebase_key>
SMTP_HOST=<email_host>
SMTP_PORT=<email_port>
SMTP_USER=<email_user>
SMTP_PASS=<email_password>
```

**Stripe Configuration**

1. **Create Stripe Account**
   - Sign up at https://stripe.com
   - Complete business verification

2. **Get API Keys**
   - Navigate to Developers → API keys
   - Copy Secret key (starts with `sk_test_` for test mode)
   - Copy Publishable key (starts with `pk_test_` for test mode)
   - For production, use live mode keys (`sk_live_` and `pk_live_`)

3. **Set Up Webhooks**
   - Go to Developers → Webhooks
   - Click "Add endpoint"
   - Enter your webhook URL: `https://yourdomain.com/api/webhooks/stripe`
   - Select events to listen for:
     - `checkout.session.completed`
     - `checkout.session.async_payment_succeeded`
     - `checkout.session.async_payment_failed`
   - Copy the webhook signing secret (starts with `whsec_`)

4. **Configure Stripe Connect** (for contractor payouts)
   - Go to Connect → Settings
   - Enable Express or Custom accounts based on your needs
   - Configure branding and onboarding settings
   - Set up payout schedules

**Note**: For complete Stripe setup instructions, see:

- Stripe Checkout: https://docs.stripe.com/payments/checkout
- Stripe Connect: https://docs.stripe.com/connect
- Webhook handling: https://docs.stripe.com/webhooks

### Database Setup

**Initial Setup**

- No manual migrations required
- Admin user auto-creates on first run
- Admin wallet auto-creates automatically
- Indexes created automatically

**Data Persistence**

- MongoDB for all data storage
- Transaction logs immutable
- Wallet balances atomic
- Job states consistent

### Service Registration

**Automated Jobs**

- Offer expiration runs hourly
- Starts automatically on server launch
- Logs all processed offers
- Error handling per offer

**Socket.IO Server**

- Real-time notification support
- Automatic reconnection
- Room-based messaging
- Event broadcasting

### Health Checks

**System Health**

- Database connectivity
- Admin user existence
- Admin wallet existence
- Automated job status

**Monitoring Points**

- Failed transactions
- Stuck offers
- Frozen wallets
- Error rates

---

## Support & Resources

### Documentation

**API Documentation**

- Swagger UI: `/swagger`
- Scalar UI: `/scaler`
- JSON Specification: `/api-docs.json`

**Implementation Guides**

- `doc/payment/IMPLEMENTATION_GUIDE.md`: Complete backend guide
- `doc/payment/API_DESIGN.md`: API architecture
- `doc/payment/DATABASE_SCHEMA.md`: Database design
- `doc/payment/REVISED_FLOW.md`: Flow diagrams
- `doc/payment/STRIPE_WEBHOOK_GUIDE.md`: Webhook implementation
- `doc/payment/STRIPE_DASHBOARD_SETUP.md`: Stripe dashboard setup

**Frontend Resources**

- `doc/payment/IMPLEMENTATION/FRONTEND_API_DOCUMENTATION.md`: Complete API reference
- `doc/payment/IMPLEMENTATION/QUICK_START_GUIDE.md`: Quick reference
- `doc/payment/IMPLEMENTATION/POSTMAN_COLLECTION_GUIDE.md`: Testing guide

### Technical Support

**Contact Channels**

- Backend Team: backend@jobsphere.com
- Technical Support: support@jobsphere.com
- Emergency Issues: emergency@jobsphere.com

**Response Times**

- Critical Issues: 1 hour
- High Priority: 4 hours
- Medium Priority: 24 hours
- Low Priority: 3 business days

### Development Resources

**Source Code**

- Admin Service: `src/common/service/admin.service.ts`
- Wallet Services: `src/api/wallet/services/`
- Offer Services: `src/api/job-request/services/`
- Job Services: `src/api/job/services/`
- Automated Jobs: `src/jobs/`

**Configuration**

- Payment Config: `src/config/payment-config.ts`
- Validation Schemas: `src/api/*/validation.ts`
- Routes: `src/api/*/routes.ts`

---

## Changelog

### Version 2.0.0 (January 28, 2026)

**Major Update: Stripe Integration**

- ✅ Stripe Checkout for customer deposits
- ✅ Stripe Connect for contractor payouts
- ✅ Webhook handling for payment confirmations
- ✅ Admin-approved withdrawal system
- ✅ Admin-approved job completion with payouts
- ✅ Removed escrow balance (simplified to single balance)
- ✅ Wallet-based transaction tracking
- ✅ Updated documentation for new flow

**Breaking Changes**

- Removed `escrowBalance` field from Wallet model
- Changed deposit flow to use Stripe Checkout URLs
- Changed withdrawal flow to require admin approval
- Changed job completion to require admin approval
- Updated transaction types to reflect new flow

**System Status**

- Build: ✅ Passing
- Stripe Integration: ✅ Ready for implementation
- Documentation: ✅ Complete
- Security: ✅ Enhanced with Stripe
- Performance: ✅ Optimized

### Version 1.0.0 (November 13, 2025)

**Initial Release**

- ✅ Wallet management system
- ✅ Offer creation and management
- ✅ Job payment processing
- ✅ Withdrawal functionality
- ✅ Automated offer expiration
- ✅ Transaction history
- ✅ Real-time notifications
- ✅ Admin service integration
- ✅ Complete API documentation
- ✅ Production-ready deployment

**System Status**

- Build: ✅ Passing
- Tests: ✅ Verified
- Documentation: ✅ Complete
- Security: ✅ Implemented
- Performance: ✅ Optimized

---

## Quick Reference

### Commission Calculation

```
Customer Pays = Job Budget × 1.05
Platform Fee = Job Budget × 0.05 (on acceptance)
Service Fee = Job Budget × 0.20 (on completion)
Contractor Gets = Job Budget × 0.80 (on completion)
Admin Total = Job Budget × 0.25 (combined)
```

### Status Flow

```
Job: open → assigned → in_progress → completed
Offer: pending → accepted → completed
Application: pending → accepted/rejected
```

### Key Limits

```
Minimum Deposit: $10
Minimum Withdrawal: $10
Maximum Withdrawal: $10,000
Offer Expiration: 7 days
Token Validity: 15 days (access), 30 days (refresh)
```

---

## Production Readiness Checklist

- ✅ All core features implemented
- ✅ Authentication and authorization
- ✅ Input validation and sanitization
- ✅ Error handling and logging
- ✅ Transaction security
- ✅ Automated processes
- ✅ API documentation
- ✅ Testing completed
- ✅ Deployment guidelines
- ✅ Support channels established

---

**System Status**: ✅ Production Ready  
**Documentation Version**: 1.0.0  
**Last Verified**: November 13, 2025

For detailed technical implementation, refer to the comprehensive documentation in the `doc/payment/` directory.
