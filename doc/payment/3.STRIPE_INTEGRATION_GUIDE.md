# 3. Stripe Integration Guide

**Version**: 1.0.0  
**Last Updated**: January 24, 2026  
**Status**: Implementation Ready
**creator**: kiro
---

## Overview

This guide provides complete instructions for integrating Stripe into the JobSphere payment system. It covers both customer deposits (Payment Intents) and contractor withdrawals (Stripe Connect).

## Table of Contents

1. [High-Level Overview](#high-level-overview)
2. [Stripe APIs to Use](#stripe-apis-to-use)
3. [Database Schema Updates](#database-schema-updates)
4. [Implementation Roadmap](#implementation-roadmap)
5. [Detailed Implementation Steps](#detailed-implementation-steps)
6. [Webhook Implementation](#webhook-implementation)
7. [Testing Guide](#testing-guide)

---

## High-Level Overview

### What You Need to Implement

**Phase 1: Customer Deposits (Payment Intents)**
- Customers add money to their wallet using credit/debit cards
- Use Stripe Payment Intents API for secure payment processing
- Implement webhook to confirm successful payments
- Update wallet balance after payment confirmation

**Phase 2: Contractor Withdrawals (Stripe Connect)**
- Contractors withdraw earnings to their bank accounts
- Use Stripe Connect Express accounts for contractor onboarding
- Implement transfers/payouts to contractor accounts
- Handle webhook events for payout status

**Phase 3: Webhook Security & Error Handling**
- Verify webhook signatures for security
- Handle failed payments and payouts
- Implement retry logic for failed operations
- Add comprehensive logging and monitoring

### Current vs Future State

**Current State** (Manual):
```
Customer Deposit:
1. Customer calls POST /api/wallet/deposit
2. Balance increases immediately (no real payment)
3. Transaction record created

Contractor Withdrawal:
1. Contractor calls POST /api/wallet/withdraw
2. Balance decreases immediately (no real payout)
3. Transaction record created
```

**Future State** (Stripe Integrated):
```
Customer Deposit:
1. Customer calls POST /api/wallet/deposit
2. Backend creates Stripe Payment Intent
3. Frontend confirms payment with Stripe
4. Stripe sends webhook on success
5. Backend updates wallet balance
6. Transaction record created

Contractor Withdrawal:
1. Contractor calls POST /api/wallet/withdraw
2. Backend creates Stripe Transfer/Payout
3. Stripe processes payout to bank account
4. Stripe sends webhook on completion
5. Backend updates transaction status
6. Contractor receives money in 2-3 days
```

---

## Stripe APIs to Use

### 1. Payment Intents API (Customer Deposits)

**Purpose**: Process credit/debit card payments from customers

**Key Endpoints**:
- `POST /v1/payment_intents` - Create payment intent
- `POST /v1/payment_intents/:id/confirm` - Confirm payment (client-side)
- `POST /v1/payment_intents/:id/cancel` - Cancel payment

**Webhook Events**:
- `payment_intent.succeeded` - Payment completed successfully
- `payment_intent.payment_failed` - Payment failed
- `payment_intent.canceled` - Payment canceled

**Documentation**: [Stripe Payment Intents](https://stripe.com/docs/payments/payment-intents)

### 2. Connect API (Contractor Onboarding)

**Purpose**: Create Stripe accounts for contractors to receive payouts

**Key Endpoints**:
- `POST /v1/accounts` - Create Express connected account
- `POST /v1/account_links` - Generate onboarding link
- `GET /v1/accounts/:id` - Get account details

**Account Type**: Express (Stripe handles onboarding UI)

**Webhook Events**:
- `account.updated` - Account information updated
- `account.external_account.created` - Bank account added

**Documentation**: [Stripe Connect Express](https://stripe.com/docs/connect/express-accounts)

### 3. Transfers/Payouts API (Contractor Withdrawals)

**Purpose**: Send money to contractor bank accounts

**Key Endpoints**:
- `POST /v1/transfers` - Transfer to connected account
- `POST /v1/payouts` - Direct payout to bank account

**Webhook Events**:
- `transfer.created` - Transfer initiated
- `transfer.paid` - Transfer completed
- `transfer.failed` - Transfer failed
- `payout.paid` - Payout completed
- `payout.failed` - Payout failed

**Documentation**: [Stripe Payouts](https://stripe.com/docs/connect/bank-debit-card-payouts)

### 4. Webhooks API (Event Notifications)

**Purpose**: Receive real-time notifications from Stripe

**Key Endpoint**:
- `POST /api/webhooks/stripe` - Your webhook endpoint

**Security**: Verify webhook signatures using `stripe.webhooks.constructEvent()`

**Documentation**: [Stripe Webhooks](https://stripe.com/docs/webhooks)

---

## Database Schema Updates

### 1. User Model Updates

**File**: `src/db/models/user.model.ts`

Add Stripe-related fields:

```typescript
export interface User {
  // ... existing fields
  
  // Stripe fields
  stripeCustomerId?: string;      // For customers (Payment Intents)
  stripeAccountId?: string;       // For contractors (Connect)
  stripeAccountStatus?: 'pending' | 'active' | 'restricted' | 'rejected';
  stripeOnboardingComplete?: boolean;
}
```

### 2. Wallet Model Updates

**File**: `src/db/models/wallet.model.ts`

Add Stripe tracking fields:

```typescript
export interface Wallet {
  // ... existing fields
  
  // Stripe fields
  pendingDeposits?: number;       // Deposits awaiting confirmation
  lastStripeSync?: Date;          // Last sync with Stripe
}
```

### 3. Transaction Model Updates

**File**: `src/db/models/transaction.model.ts`

Add Stripe reference fields:

```typescript
export interface Transaction {
  // ... existing fields
  
  // Stripe fields
  stripePaymentIntentId?: string;  // For deposits
  stripeTransferId?: string;       // For withdrawals
  stripePayoutId?: string;         // For payouts
  stripeStatus?: string;           // Stripe's status
  stripeError?: string;            // Error message from Stripe
}
```

---

## Implementation Roadmap

### Phase 1: Setup & Configuration (Week 1)

**Tasks**:
1. Create Stripe account and get API keys
2. Install Stripe SDK: `npm install stripe`
3. Add environment variables
4. Update database models
5. Create Stripe service utility

**Deliverables**:
- Stripe account configured
- API keys stored securely
- Database migrations completed
- Stripe service initialized

### Phase 2: Customer Deposits (Week 2-3)

**Tasks**:
1. Update deposit service to create Payment Intents
2. Implement webhook endpoint for payment confirmation
3. Update wallet balance on successful payment
4. Add error handling for failed payments
5. Test deposit flow end-to-end

**Deliverables**:
- Working deposit API with Stripe
- Webhook handling payment events
- Frontend integration guide
- Test cases passing

### Phase 3: Contractor Onboarding (Week 4)

**Tasks**:
1. Create Connect account creation endpoint
2. Generate onboarding links for contractors
3. Handle account update webhooks
4. Store Stripe account IDs in database
5. Add account status checking

**Deliverables**:
- Contractor onboarding flow
- Account verification handling
- Status tracking system
- Documentation for contractors

### Phase 4: Contractor Withdrawals (Week 5-6)

**Tasks**:
1. Update withdrawal service to create Transfers
2. Implement webhook for transfer status
3. Handle payout failures and retries
4. Add withdrawal limits and validation
5. Test withdrawal flow end-to-end

**Deliverables**:
- Working withdrawal API with Stripe
- Webhook handling transfer events
- Error handling and retries
- Test cases passing

### Phase 5: Testing & Security (Week 7)

**Tasks**:
1. Implement webhook signature verification
2. Add comprehensive error handling
3. Write integration tests
4. Perform security audit
5. Load testing

**Deliverables**:
- Secure webhook implementation
- Complete test coverage
- Security audit report
- Performance benchmarks

### Phase 6: Production Deployment (Week 8)

**Tasks**:
1. Switch to production API keys
2. Configure production webhooks
3. Deploy to production
4. Monitor for issues
5. Document operational procedures

**Deliverables**:
- Production deployment
- Monitoring dashboards
- Incident response plan
- User documentation

---

## Detailed Implementation Steps

### Step 1: Environment Setup

**1.1 Install Stripe SDK**

```bash
npm install stripe
# or
pnpm add stripe
```

**1.2 Add Environment Variables**

Add to `.env`:

```env
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_CONNECT_CLIENT_ID=ca_...

# For production, use live keys:
# STRIPE_SECRET_KEY=sk_live_...
# STRIPE_PUBLISHABLE_KEY=pk_live_...
```

**1.3 Create Stripe Service**

Create `src/lib/stripe.ts`:

```typescript
import Stripe from 'stripe';
import { Env } from './Env';

if (!Env.STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY is required');
}

export const stripe = new Stripe(Env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-12-18.acacia', // Use latest API version
  typescript: true,
});

// Export publishable key for frontend
export const STRIPE_PUBLISHABLE_KEY = Env.STRIPE_PUBLISHABLE_KEY;
```

**1.4 Update Env Configuration**

Add to `src/lib/Env.ts`:

```typescript
export const Env = {
  // ... existing fields
  
  // Stripe
  STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY!,
  STRIPE_PUBLISHABLE_KEY: process.env.STRIPE_PUBLISHABLE_KEY!,
  STRIPE_WEBHOOK_SECRET: process.env.STRIPE_WEBHOOK_SECRET!,
  STRIPE_CONNECT_CLIENT_ID: process.env.STRIPE_CONNECT_CLIENT_ID,
};
```

### Step 2: Update Database Models

**2.1 Update User Model**

File: `src/db/models/user.model.ts`

```typescript
const userSchema = new Schema<UserDocument>({
  // ... existing fields
  
  // Stripe fields
  stripeCustomerId: {
    type: String,
    sparse: true,
    index: true,
  },
  stripeAccountId: {
    type: String,
    sparse: true,
    index: true,
  },
  stripeAccountStatus: {
    type: String,
    enum: ['pending', 'active', 'restricted', 'rejected'],
  },
  stripeOnboardingComplete: {
    type: Boolean,
    default: false,
  },
}, { timestamps: true });
```

**2.2 Update Wallet Model**

File: `src/db/models/wallet.model.ts`

```typescript
const walletSchema = new Schema<WalletDocument>({
  // ... existing fields
  
  // Stripe tracking
  pendingDeposits: {
    type: Number,
    default: 0,
    min: 0,
  },
  lastStripeSync: Date,
}, { timestamps: true });
```

**2.3 Update Transaction Model**

File: `src/db/models/transaction.model.ts`

```typescript
const transactionSchema = new Schema<TransactionDocument>({
  // ... existing fields
  
  // Stripe references
  stripePaymentIntentId: {
    type: String,
    sparse: true,
    index: true,
  },
  stripeTransferId: {
    type: String,
    sparse: true,
    index: true,
  },
  stripePayoutId: {
    type: String,
    sparse: true,
    index: true,
  },
  stripeStatus: String,
  stripeError: String,
}, { timestamps: true });
```

### Step 3: Implement Customer Deposits

**3.1 Update Deposit Service**

File: `src/api/wallet/services/deposit.service.ts`

```typescript
import { stripe } from '@/lib/stripe';
import { db } from '@/db';
import { sendBadRequest, sendSuccess, sendInternalError } from '@/helpers';
import type { RequestHandler } from 'express';
import type { Deposit } from '../wallet.validation';

export const deposit: RequestHandler<{}, any, Deposit> = async (req, res) => {
  try {
    const userId = req?.user?.id;
    const { amount, paymentMethodId } = req.body;

    // Validate amount
    if (amount < 10) {
      return sendBadRequest(res, 'Minimum deposit amount is $10');
    }

    // Get or create wallet
    let wallet = await db.wallet.findOne({ user: userId });
    if (!wallet) {
      wallet = await db.wallet.create({
        user: userId,
        balance: 0,
        escrowBalance: 0,
      });
    }

    // Get or create Stripe customer
    let user = await db.user.findById(userId);
    if (!user) {
      return sendBadRequest(res, 'User not found');
    }

    if (!user.stripeCustomerId) {
      const customer = await stripe.customers.create({
        email: user.email,
        metadata: {
          userId: userId.toString(),
        },
      });
      user.stripeCustomerId = customer.id;
      await user.save();
    }

    // Create Payment Intent
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // Convert to cents
      currency: 'usd',
      customer: user.stripeCustomerId,
      payment_method: paymentMethodId,
      confirm: true, // Confirm immediately
      automatic_payment_methods: {
        enabled: true,
        allow_redirects: 'never',
      },
      metadata: {
        userId: userId.toString(),
        walletId: wallet._id.toString(),
        type: 'wallet_deposit',
      },
    });

    // Create pending transaction
    const transaction = await db.transaction.create({
      type: 'deposit',
      amount,
      from: userId,
      to: userId,
      status: 'pending',
      description: `Wallet deposit of $${amount}`,
      stripePaymentIntentId: paymentIntent.id,
      stripeStatus: paymentIntent.status,
    });

    // Update pending deposits
    wallet.pendingDeposits = (wallet.pendingDeposits || 0) + amount;
    await wallet.save();

    return sendSuccess(res, 200, 'Payment initiated', {
      paymentIntent: {
        id: paymentIntent.id,
        status: paymentIntent.status,
        clientSecret: paymentIntent.client_secret,
      },
      transaction: {
        id: transaction._id,
        amount,
        status: 'pending',
      },
    });
  } catch (error: any) {
    console.error('Error creating payment intent:', error);
    
    if (error.type === 'StripeCardError') {
      return sendBadRequest(res, error.message);
    }
    
    return sendInternalError(res, 'Failed to process deposit', error);
  }
};
```

**3.2 Create Webhook Handler**

Create `src/api/webhooks/stripe-webhook.service.ts`:

```typescript
import { stripe } from '@/lib/stripe';
import { Env } from '@/lib/Env';
import { db } from '@/db';
import type { RequestHandler } from 'express';
import type Stripe from 'stripe';

export const handleStripeWebhook: RequestHandler = async (req, res) => {
  const sig = req.headers['stripe-signature'];

  if (!sig) {
    return res.status(400).send('Missing stripe-signature header');
  }

  let event: Stripe.Event;

  try {
    // Verify webhook signature
    event = stripe.webhooks.constructEvent(
      req.body,
      sig,
      Env.STRIPE_WEBHOOK_SECRET
    );
  } catch (err: any) {
    console.error('Webhook signature verification failed:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // Handle the event
  try {
    switch (event.type) {
      case 'payment_intent.succeeded':
        await handlePaymentIntentSucceeded(event.data.object);
        break;
      
      case 'payment_intent.payment_failed':
        await handlePaymentIntentFailed(event.data.object);
        break;
      
      case 'transfer.paid':
        await handleTransferPaid(event.data.object);
        break;
      
      case 'transfer.failed':
        await handleTransferFailed(event.data.object);
        break;
      
      default:
        console.log(`Unhandled event type: ${event.type}`);
    }

    res.json({ received: true });
  } catch (error) {
    console.error('Error handling webhook:', error);
    res.status(500).send('Webhook handler failed');
  }
};

async function handlePaymentIntentSucceeded(paymentIntent: Stripe.PaymentIntent) {
  const { userId, walletId } = paymentIntent.metadata;
  const amount = paymentIntent.amount / 100; // Convert from cents

  // Find transaction
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
  });

  if (!transaction) {
    console.error('Transaction not found for payment intent:', paymentIntent.id);
    return;
  }

  // Update transaction
  transaction.status = 'completed';
  transaction.stripeStatus = paymentIntent.status;
  transaction.completedAt = new Date();
  await transaction.save();

  // Update wallet
  const wallet = await db.wallet.findById(walletId);
  if (wallet) {
    wallet.balance += amount;
    wallet.pendingDeposits = Math.max(0, (wallet.pendingDeposits || 0) - amount);
    wallet.lastStripeSync = new Date();
    await wallet.save();
  }

  console.log(`Payment succeeded: $${amount} added to wallet ${walletId}`);
}

async function handlePaymentIntentFailed(paymentIntent: Stripe.PaymentIntent) {
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
  });

  if (!transaction) {
    return;
  }

  transaction.status = 'failed';
  transaction.stripeStatus = paymentIntent.status;
  transaction.stripeError = paymentIntent.last_payment_error?.message;
  await transaction.save();

  // Update pending deposits
  const wallet = await db.wallet.findById(transaction.to);
  if (wallet) {
    wallet.pendingDeposits = Math.max(0, (wallet.pendingDeposits || 0) - transaction.amount);
    await wallet.save();
  }

  console.error(`Payment failed for intent ${paymentIntent.id}`);
}

async function handleTransferPaid(transfer: Stripe.Transfer) {
  // Handle contractor withdrawal completion
  const transaction = await db.transaction.findOne({
    stripeTransferId: transfer.id,
  });

  if (!transaction) {
    return;
  }

  transaction.status = 'completed';
  transaction.stripeStatus = 'paid';
  transaction.completedAt = new Date();
  await transaction.save();

  console.log(`Transfer completed: ${transfer.id}`);
}

async function handleTransferFailed(transfer: Stripe.Transfer) {
  const transaction = await db.transaction.findOne({
    stripeTransferId: transfer.id,
  });

  if (!transaction) {
    return;
  }

  transaction.status = 'failed';
  transaction.stripeStatus = 'failed';
  transaction.stripeError = transfer.failure_message || 'Transfer failed';
  await transaction.save();

  // Refund to wallet
  const wallet = await db.wallet.findOne({ user: transaction.from });
  if (wallet) {
    wallet.balance += transaction.amount;
    await wallet.save();
  }

  console.error(`Transfer failed: ${transfer.id}`);
}
```

**3.3 Create Webhook Route**

Create `src/api/webhooks/webhook.route.ts`:

```typescript
import express, { type Router } from 'express';
import { handleStripeWebhook } from './stripe-webhook.service';

export const webhook: Router = express.Router();

// Stripe webhook (raw body required)
webhook.post(
  '/stripe',
  express.raw({ type: 'application/json' }),
  handleStripeWebhook
);
```

**3.4 Register Webhook Route**

Update `src/app.ts`:

```typescript
import { webhook } from '@/api/webhooks/webhook.route';

// Register webhook BEFORE body parser middleware
app.use('/api/webhooks', webhook);

// Then register body parser
app.use(express.json());
```

### Step 4: Implement Contractor Onboarding

**4.1 Create Connect Account Service**

Create `src/api/wallet/services/create-connect-account.service.ts`:

```typescript
import { stripe } from '@/lib/stripe';
import { db } from '@/db';
import { sendBadRequest, sendSuccess, sendInternalError } from '@/helpers';
import type { RequestHandler } from 'express';

export const createConnectAccount: RequestHandler = async (req, res) => {
  try {
    const userId = req?.user?.id;
    const user = await db.user.findById(userId);

    if (!user) {
      return sendBadRequest(res, 'User not found');
    }

    if (user.role !== 'contractor') {
      return sendBadRequest(res, 'Only contractors can create payout accounts');
    }

    // Check if account already exists
    if (user.stripeAccountId) {
      return sendSuccess(res, 200, 'Connect account already exists', {
        accountId: user.stripeAccountId,
        status: user.stripeAccountStatus,
        onboardingComplete: user.stripeOnboardingComplete,
      });
    }

    // Create Express connected account
    const account = await stripe.accounts.create({
      type: 'express',
      country: 'US', // Adjust based on your needs
      email: user.email,
      capabilities: {
        transfers: { requested: true },
      },
      metadata: {
        userId: userId.toString(),
      },
    });

    // Save account ID
    user.stripeAccountId = account.id;
    user.stripeAccountStatus = 'pending';
    user.stripeOnboardingComplete = false;
    await user.save();

    // Create account link for onboarding
    const accountLink = await stripe.accountLinks.create({
      account: account.id,
      refresh_url: `${process.env.CLIENT_URL}/dashboard/settings/payout?refresh=true`,
      return_url: `${process.env.CLIENT_URL}/dashboard/settings/payout?success=true`,
      type: 'account_onboarding',
    });

    return sendSuccess(res, 201, 'Connect account created', {
      accountId: account.id,
      onboardingUrl: accountLink.url,
    });
  } catch (error: any) {
    console.error('Error creating connect account:', error);
    return sendInternalError(res, 'Failed to create payout account', error);
  }
};
```

**4.2 Add Connect Account Route**

Update `src/api/wallet/wallet.route.ts`:

```typescript
import { createConnectAccount } from './services/create-connect-account.service';

// Create Stripe Connect account (contractors only)
wallet.post(
  '/connect-account',
  requireAuth,
  requireRole('contractor'),
  createConnectAccount
);
```

### Step 5: Implement Contractor Withdrawals

**5.1 Update Withdrawal Service**

Update `src/api/wallet/services/withdraw.service.ts`:

```typescript
import { stripe } from '@/lib/stripe';
import { db } from '@/db';
import { sendBadRequest, sendSuccess, sendInternalError } from '@/helpers';
import type { RequestHandler } from 'express';
import type { Withdraw } from '../wallet.validation';

export const withdraw: RequestHandler<{}, any, Withdraw> = async (req, res) => {
  try {
    const userId = req?.user?.id;
    const { amount } = req.body;

    // Only contractors can withdraw
    if (req?.user?.role !== 'contractor') {
      return sendBadRequest(res, 'Only contractors can withdraw funds');
    }

    // Validate amount
    if (amount < 10) {
      return sendBadRequest(res, 'Minimum withdrawal amount is $10');
    }

    if (amount > 10000) {
      return sendBadRequest(res, 'Maximum withdrawal amount is $10,000');
    }

    // Get user and check Stripe account
    const user = await db.user.findById(userId);
    if (!user) {
      return sendBadRequest(res, 'User not found');
    }

    if (!user.stripeAccountId) {
      return sendBadRequest(res, 'Please complete payout account setup first');
    }

    if (!user.stripeOnboardingComplete) {
      return sendBadRequest(res, 'Please complete payout account verification');
    }

    // Check wallet balance atomically
    const wallet = await db.wallet.findOneAndUpdate(
      {
        user: userId,
        balance: { $gte: amount },
        isFrozen: false,
      },
      {
        $inc: {
          balance: -amount,
          totalWithdrawals: amount,
        },
      },
      { new: true }
    );

    if (!wallet) {
      const existingWallet = await db.wallet.findOne({ user: userId });
      
      if (!existingWallet) {
        return sendBadRequest(res, 'Wallet not found');
      }

      if (existingWallet.isFrozen) {
        return sendBadRequest(res, 'Wallet is frozen. Please contact support.');
      }

      return sendBadRequest(
        res,
        `Insufficient balance. Available: $${existingWallet.balance}`
      );
    }

    // Create Stripe transfer
    const transfer = await stripe.transfers.create({
      amount: Math.round(amount * 100), // Convert to cents
      currency: 'usd',
      destination: user.stripeAccountId,
      metadata: {
        userId: userId.toString(),
        walletId: wallet._id.toString(),
        type: 'contractor_withdrawal',
      },
    });

    // Create transaction record
    const transaction = await db.transaction.create({
      type: 'withdrawal',
      amount,
      from: userId,
      to: userId,
      status: 'pending',
      description: `Withdrawal of $${amount}`,
      stripeTransferId: transfer.id,
      stripeStatus: transfer.status || 'pending',
    });

    return sendSuccess(res, 200, 'Withdrawal initiated', {
      amount,
      newBalance: wallet.balance,
      transferId: transfer.id,
      estimatedArrival: '2-3 business days',
      transaction: {
        id: transaction._id,
        status: 'pending',
      },
    });
  } catch (error: any) {
    console.error('Error processing withdrawal:', error);
    
    // Rollback wallet deduction on Stripe error
    if (error.type?.startsWith('Stripe')) {
      await db.wallet.findOneAndUpdate(
        { user: req?.user?.id },
        {
          $inc: {
            balance: req.body.amount,
            totalWithdrawals: -req.body.amount,
          },
        }
      );
    }
    
    return sendInternalError(res, 'Failed to process withdrawal', error);
  }
};
```

---

## Webhook Implementation

### Webhook Security

**Always verify webhook signatures**:

```typescript
const event = stripe.webhooks.constructEvent(
  req.body,
  req.headers['stripe-signature'],
  Env.STRIPE_WEBHOOK_SECRET
);
```

### Webhook Events to Handle

**Payment Events**:
- `payment_intent.succeeded` - Update wallet balance
- `payment_intent.payment_failed` - Mark transaction as failed
- `payment_intent.canceled` - Refund pending deposit

**Transfer Events**:
- `transfer.created` - Transfer initiated
- `transfer.paid` - Transfer completed (update transaction)
- `transfer.failed` - Transfer failed (refund to wallet)

**Account Events**:
- `account.updated` - Update contractor account status
- `account.external_account.created` - Bank account added

### Webhook Configuration

**Development** (using Stripe CLI):
```bash
stripe listen --forward-to localhost:4000/api/webhooks/stripe
```

**Production**:
1. Go to Stripe Dashboard → Developers → Webhooks
2. Add endpoint: `https://yourdomain.com/api/webhooks/stripe`
3. Select events to listen for
4. Copy webhook signing secret to `.env`

---

## Testing Guide

### Test Mode

Use Stripe test mode for development:
- Test API keys start with `sk_test_` and `pk_test_`
- Use test card numbers (e.g., `4242 4242 4242 4242`)
- No real money is processed

### Test Cards

**Successful Payment**:
- Card: `4242 4242 4242 4242`
- Expiry: Any future date
- CVC: Any 3 digits

**Failed Payment**:
- Card: `4000 0000 0000 0002`
- Triggers card declined error

**Requires Authentication**:
- Card: `4000 0025 0000 3155`
- Triggers 3D Secure authentication

### Testing Webhooks Locally

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:4000/api/webhooks/stripe

# Trigger test events
stripe trigger payment_intent.succeeded
stripe trigger transfer.paid
```

### Integration Tests

Create `tests/stripe-integration.test.ts`:

```typescript
describe('Stripe Integration', () => {
  it('should create payment intent for deposit', async () => {
    // Test deposit flow
  });

  it('should handle successful payment webhook', async () => {
    // Test webhook handling
  });

  it('should create connect account for contractor', async () => {
    // Test account creation
  });

  it('should process withdrawal with transfer', async () => {
    // Test withdrawal flow
  });
});
```

---

## Summary

This guide provides complete instructions for integrating Stripe into your payment system. Follow the implementation roadmap and detailed steps to add real payment processing to customer deposits and contractor withdrawals.

**Next Steps**:
1. Review the task list in `4.STRIPE_INTEGRATION_TASKLIST.md`
2. Set up Stripe account and get API keys
3. Start with Phase 1 (Setup & Configuration)
4. Implement features incrementally
5. Test thoroughly before production deployment

**Related Documentation**:
- [1. System Overview](./1.MAIN-REFERENCE.md)
- [2. Backend Implementation](./2.BACKEND_IMPLEMENTATION.md)
- [4. Stripe Integration Tasklist](./4.STRIPE_INTEGRATION_TASKLIST.md)
