# 2. Backend Implementation Guide

**Version**: 1.0.0  
**Last Updated**: January 24, 2026  
**Status**: Production Ready

---

## Overview

This guide covers the complete backend implementation of the JobSphere payment system, including database models, services, routes, and business logic.

## Table of Contents

1. [Database Models](#database-models)
2. [Payment Configuration](#payment-configuration)
3. [Wallet Module](#wallet-module)
4. [Offer Module](#offer-module)
5. [Job Completion](#job-completion)
6. [Transaction Management](#transaction-management)
7. [Error Handling](#error-handling)

---

## Database Models

### Wallet Model

**File**: `src/db/models/wallet.model.ts`

The wallet model tracks user balances and escrow funds.

**Key Fields**:

- `balance`: Available funds for spending
- `escrowBalance`: Funds held for pending offers
- `totalEarnings`: Lifetime earnings (contractors)
- `totalSpent`: Lifetime spending (customers)
- `totalWithdrawals`: Lifetime withdrawals (contractors)
- `isFrozen`: Security flag for admin control

**Schema**:

```typescript
{
  user: ObjectId (unique, indexed),
  balance: Number (default: 0, min: 0),
  escrowBalance: Number (default: 0, min: 0),
  currency: String (default: "USD"),
  isActive: Boolean (default: true),
  isFrozen: Boolean (default: false),
  totalEarnings: Number (default: 0),
  totalSpent: Number (default: 0),
  totalWithdrawals: Number (default: 0)
}
```

### Offer Model

**File**: `src/db/models/offer.model.ts`

The offer model represents a job offer with payment details.

**Key Fields**:

- `amount`: Job budget (e.g., $100)
- `platformFee`: 5% charged to customer (e.g., $5)
- `serviceFee`: 20% deducted from contractor (e.g., $20)
- `contractorPayout`: 80% paid to contractor (e.g., $80)
- `totalCharge`: Total charged to customer (e.g., $105)
- `status`: pending, accepted, rejected, cancelled, completed, expired

**Schema**:

```typescript
{
  job: ObjectId (indexed, unique),
  customer: ObjectId (indexed),
  contractor: ObjectId (indexed),
  application: ObjectId (indexed),
  amount: Number (required),
  platformFee: Number (required),
  serviceFee: Number (required),
  contractorPayout: Number (required),
  totalCharge: Number (required),
  timeline: String (required),
  description: String (required),
  status: String (enum, default: "pending"),
  acceptedAt: Date,
  rejectedAt: Date,
  cancelledAt: Date,
  completedAt: Date,
  expiresAt: Date,
  rejectionReason: String,
  cancellationReason: String
}
```

**Important**: One offer per job enforced by unique index on `job` field.

### Transaction Model

**File**: `src/db/models/transaction.model.ts`

The transaction model provides complete audit trail of all money movements.

**Transaction Types**:

- `deposit`: Money added to wallet
- `withdrawal`: Money withdrawn from wallet
- `escrow_hold`: Money moved to escrow
- `escrow_release`: Money released from escrow
- `platform_fee`: 5% fee to admin
- `service_fee`: 20% fee to admin
- `contractor_payout`: Payment to contractor
- `refund`: Money returned to customer

**Schema**:

```typescript
{
  type: String (enum, indexed),
  amount: Number (required),
  from: ObjectId (indexed),
  to: ObjectId (indexed),
  offer: ObjectId (indexed, optional),
  job: ObjectId (indexed, optional),
  status: String (enum: pending, completed, failed),
  description: String (required),
  failureReason: String,
  completedAt: Date
}
```

---

## Payment Configuration

**File**: `src/common/payment-config.ts`

Centralized payment configuration and calculation logic.

**Constants**:

```typescript
export const PAYMENT_CONFIG = {
  PLATFORM_FEE_PERCENT: 5, // Charged to customer
  SERVICE_FEE_PERCENT: 20, // Deducted from contractor
  BUYER_TOTAL_PERCENT: 105, // Customer pays 105%
  CONTRACTOR_PAYOUT_PERCENT: 80, // Contractor gets 80%
  ADMIN_TOTAL_PERCENT: 25, // Admin gets 25% total
  CURRENCY: "USD",
  MIN_JOB_BUDGET: 10,
  MAX_JOB_BUDGET: 10000,
  OFFER_EXPIRY_DAYS: 7,
};
```

**Calculation Function**:

```typescript
export const calculatePaymentAmounts = (jobBudget: number) => {
  const platformFee = jobBudget * 0.05;
  const serviceFee = jobBudget * 0.2;
  const contractorPayout = jobBudget - serviceFee;
  const totalCharge = jobBudget + platformFee;
  const adminTotal = platformFee + serviceFee;

  return {
    jobBudget,
    platformFee,
    serviceFee,
    contractorPayout,
    totalCharge,
    adminTotal,
  };
};
```

**Example**:

```typescript
calculatePaymentAmounts(100);
// Returns:
// {
//   jobBudget: 100,
//   platformFee: 5,
//   serviceFee: 20,
//   contractorPayout: 80,
//   totalCharge: 105,
//   adminTotal: 25
// }
```

---

## Wallet Module

### Get Wallet Service

**File**: `src/api/wallet/services/get-wallet.service.ts`

Retrieves or creates user wallet.

**Logic**:

1. Find wallet by user ID
2. If not found, create new wallet with zero balance
3. Return wallet data

**Response**:

```json
{
  "status": 200,
  "message": "Wallet retrieved successfully",
  "data": {
    "_id": "wallet_id",
    "user": "user_id",
    "balance": 1000,
    "escrowBalance": 105,
    "currency": "USD",
    "totalEarnings": 5000,
    "totalSpent": 2000,
    "isActive": true,
    "isFrozen": false
  }
}
```

### Deposit Service

**File**: `src/api/wallet/services/deposit.service.ts`

Adds money to user wallet (currently manual, Stripe integration pending).

**Logic**:

1. Validate minimum amount ($10)
2. Get or create wallet
3. Add amount to balance
4. Create transaction record
5. Return updated wallet

**Current Implementation** (Manual):

```typescript
wallet.balance += amount;
await wallet.save();

await db.transaction.create({
  type: "deposit",
  amount,
  from: userId,
  to: userId,
  status: "completed",
  description: `Wallet deposit of ${amount}`,
  completedAt: new Date(),
});
```

**Future Implementation** (Stripe):

- Create Payment Intent
- Confirm payment with Stripe
- Update wallet via webhook
- See Stripe Integration Guide for details

### Withdraw Service

**File**: `src/api/wallet/services/withdraw.service.ts`

Allows contractors to withdraw funds (currently manual, Stripe Connect pending).

**Logic**:

1. Verify user is contractor
2. Validate minimum amount ($10)
3. Check sufficient balance
4. Check wallet not frozen
5. Deduct from balance
6. Create transaction record
7. Return confirmation

**Authorization**: Contractors only

**Validation**:

- Minimum: $10
- Maximum: $10,000
- Must have sufficient balance
- Wallet must not be frozen

### Get Transactions Service

**File**: `src/api/wallet/services/get-transactions.service.ts`

Retrieves transaction history with pagination and filtering.

**Query Parameters**:

- `page`: Page number (default: 1)
- `limit`: Items per page (default: 10)
- `type`: Filter by transaction type (optional)

**Logic**:

1. Build query (transactions where user is sender or receiver)
2. Apply type filter if provided
3. Sort by creation date (newest first)
4. Apply pagination
5. Populate user details
6. Return transactions with pagination metadata

**Response**:

```json
{
  "status": 200,
  "message": "Transactions retrieved successfully",
  "data": {
    "transactions": [...],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 50,
      "totalPages": 5
    }
  }
}
```

---

## Offer Module

### Send Offer Service

**File**: `src/api/job-request/services/send-offer.service.ts`

Customer sends job offer to contractor with escrow payment.

**Logic Flow**:

1. Validate application exists
2. Verify customer owns the job
3. Check job status is "open"
4. Check no existing offer for this job
5. Calculate payment amounts
6. Check wallet balance sufficient
7. Create offer record
8. Deduct from wallet balance
9. Add to escrow balance
10. Create escrow_hold transaction
11. Update application status to "offer_sent"
12. Send notification to contractor

**Key Validations**:

- Customer must own the job
- Job must be "open" status
- Only one offer per job allowed
- Customer must have sufficient balance

**Atomic Operation**:
Uses MongoDB transactions to ensure all operations succeed or fail together.

**Example**:

```typescript
// Customer has $200 balance
// Sends $100 offer
// Result:
// - balance: $95 (200 - 105)
// - escrowBalance: $105
// - Offer created with status "pending"
// - Transaction record created
// - Contractor notified
```

### Accept Offer Service

**File**: `src/api/job-request/services/accept-offer.service.ts`

Contractor accepts offer, triggering platform fee payment and job assignment.

**Logic Flow**:

1. Validate offer exists and is pending
2. Verify contractor is offer recipient
3. Update offer status to "accepted"
4. Update job status to "assigned"
5. Assign contractor to job
6. Transfer platform fee ($5) to admin
7. Reduce customer escrow by platform fee
8. Create platform_fee transaction
9. Reject all other applications for this job
10. Send notifications (customer + rejected applicants)

**Money Movement**:

```
Before Accept:
- Customer escrow: $105
- Admin balance: $0
- Contractor balance: $0

After Accept:
- Customer escrow: $100 (105 - 5)
- Admin balance: $5 (platform fee)
- Contractor balance: $0 (waits for completion)
```

**Atomic Operation**:
All database updates happen in a single transaction.

### Reject Offer Service

**File**: `src/api/job-request/services/reject-offer.service.ts`

Contractor rejects offer, triggering full refund to customer.

**Logic Flow**:

1. Validate offer exists and is pending
2. Verify contractor is offer recipient
3. Update offer status to "rejected"
4. Update application status to "rejected"
5. Refund full amount to customer wallet
6. Release from escrow
7. Create refund transaction
8. Send notification to customer

**Money Movement**:

```
Before Reject:
- Customer balance: $95
- Customer escrow: $105
- Admin balance: $0

After Reject:
- Customer balance: $200 (95 + 105 refund)
- Customer escrow: $0
- Admin balance: $0
```

**Customer Can**:

- Send new offer to same or different contractor
- Cancel the job
- Wait for other applications

---

## Job Completion

### Complete Job Service

**File**: `src/api/job/services/complete-job.service.ts`

Customer marks job complete, releasing payment to contractor.

**Logic Flow**:

1. Validate job exists and is "in_progress"
2. Verify customer owns the job
3. Get accepted offer
4. Update job status to "completed"
5. Update offer status to "completed"
6. Transfer service fee ($20) to admin
7. Transfer contractor payout ($80) to contractor
8. Release from customer escrow
9. Create service_fee transaction
10. Create contractor_payout transaction
11. Send notification to contractor

**Money Movement**:

```
Before Complete:
- Customer escrow: $100
- Admin balance: $5 (from platform fee)
- Contractor balance: $0

After Complete:
- Customer escrow: $0
- Admin balance: $25 (5 + 20 service fee)
- Contractor balance: $80
```

**Prerequisites**:

- Job must be "in_progress" status
- Customer must own the job
- Offer must be "accepted" status

**Atomic Operation**:
All money transfers happen in a single MongoDB transaction.

### Cancel Job Service

**File**: `src/api/job/services/cancel-job.service.ts`

Customer or admin cancels job, triggering refund if offer exists.

**Logic Flow**:

1. Validate job exists
2. Verify customer owns job or user is admin
3. Check job not already completed
4. Update job status to "cancelled"
5. If offer exists and accepted:
   - Update offer status to "cancelled"
   - Refund full amount to customer
   - Release from escrow
   - Create refund transaction
6. Send notification to contractor (if assigned)

**Money Movement** (if offer accepted):

```
Before Cancel:
- Customer escrow: $100
- Admin balance: $5
- Contractor balance: $0

After Cancel:
- Customer escrow: $0
- Customer balance: +$105 (full refund including platform fee)
- Admin balance: $0 (platform fee refunded)
- Contractor balance: $0
```

**Authorization**:

- Customer who owns the job
- Admin users

---

## Transaction Management

### Transaction Creation

All money movements create transaction records for audit trail.

**Best Practices**:

1. Always use MongoDB transactions for atomic operations
2. Create transaction record before money movement
3. Update transaction status after completion
4. Include descriptive messages
5. Link to offer and job when applicable

**Example**:

```typescript
const session = await mongoose.startSession();
session.startTransaction();

try {
  // Create transaction
  const transaction = await db.transaction.create(
    [
      {
        type: "contractor_payout",
        amount: 80,
        from: customerId,
        to: contractorId,
        offer: offerId,
        job: jobId,
        status: "pending",
        description: "Contractor payout for completed job",
      },
    ],
    { session }
  );

  // Update wallets
  await db.wallet.findOneAndUpdate(
    { user: contractorId },
    { $inc: { balance: 80, totalEarnings: 80 } },
    { session }
  );

  // Complete transaction
  transaction[0].status = "completed";
  transaction[0].completedAt = new Date();
  await transaction[0].save({ session });

  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

### Transaction Query Optimization

**Indexes**:

```typescript
// Compound indexes for common queries
transactionSchema.index({ type: 1, status: 1, createdAt: -1 });
transactionSchema.index({ from: 1, createdAt: -1 });
transactionSchema.index({ to: 1, createdAt: -1 });
transactionSchema.index({ offer: 1 });
transactionSchema.index({ job: 1 });
```

**Query Patterns**:

```typescript
// User's transaction history
db.transaction
  .find({
    $or: [{ from: userId }, { to: userId }],
  })
  .sort({ createdAt: -1 });

// Offer-related transactions
db.transaction.find({ offer: offerId });

// Failed transactions
db.transaction.find({ status: "failed" });

// Transactions by type
db.transaction.find({ type: "contractor_payout" });
```

---

## Error Handling

### Validation Errors

**Insufficient Balance**:

```typescript
if (wallet.balance < amounts.totalCharge) {
  return sendBadRequest(
    res,
    `Insufficient balance. Required: ${amounts.totalCharge}, Available: ${wallet.balance}`
  );
}
```

**Frozen Wallet**:

```typescript
if (wallet.isFrozen) {
  return sendBadRequest(res, "Wallet is frozen. Please contact support.");
}
```

**Invalid Job Status**:

```typescript
if (job.status !== "open") {
  return sendBadRequest(res, "Job is not open for offers");
}
```

### Authorization Errors

**Not Job Owner**:

```typescript
if (job.customerId.toString() !== customerId) {
  return sendBadRequest(res, "Not authorized");
}
```

**Wrong User Role**:

```typescript
if (req.user!.role !== "contractor") {
  return sendBadRequest(res, "Only contractors can withdraw funds");
}
```

### Database Errors

**Transaction Rollback**:

```typescript
try {
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  console.error("Transaction failed:", error);
  return sendInternalError(res, "Failed to process payment");
} finally {
  session.endSession();
}
```

**Duplicate Offer**:

```typescript
const existingOffer = await db.offer.findOne({
  job: jobId,
  status: { $in: ["pending", "accepted"] },
});

if (existingOffer) {
  return sendBadRequest(res, "An offer already exists for this job");
}
```

### Notification Integration

**Send Notification Helper**:

```typescript
import { NotificationService } from "@/common/service/notification.service";

await NotificationService.sendToUser({
  userId: contractorId,
  title: "New Offer Received",
  body: `You received an offer of $${amount} for "${job.title}"`,
  type: "booking_confirmed",
  data: {
    offerId: offer._id.toString(),
    jobId: job._id.toString(),
    amount: amount.toString(),
  },
});
```

**Notification Types**:

- `booking_confirmed`: Offer sent/accepted
- `booking_declined`: Offer rejected
- `payment_received`: Money received
- `general`: Other notifications

---

## Summary

### Key Implementation Points

1. **Atomic Operations**: Always use MongoDB transactions for money movements
2. **Validation First**: Check all conditions before making changes
3. **Transaction Records**: Create audit trail for every money movement
4. **Notifications**: Keep users informed of payment events
5. **Error Handling**: Provide clear, actionable error messages
6. **Authorization**: Verify user permissions before operations
7. **Idempotency**: Prevent duplicate operations (one offer per job)

### Money Flow Summary

**Customer Sends Offer**:

- Balance → Escrow
- Transaction: escrow_hold

**Contractor Accepts**:

- Escrow → Admin (platform fee)
- Transaction: platform_fee

**Job Completed**:

- Escrow → Admin (service fee)
- Escrow → Contractor (payout)
- Transactions: service_fee, contractor_payout

**Offer Rejected/Job Cancelled**:

- Escrow → Customer balance
- Transaction: refund

### Next Steps

1. Review database models in `src/db/models/`
2. Implement wallet services in `src/api/wallet/services/`
3. Extend job-request module for offers
4. Add job completion logic
5. Test all payment flows
6. Integrate Stripe (see Stripe Integration Guide)

---

**Related Documentation**:

- [1. System Overview](./1.SYSTEM_OVERVIEW.md)
- [3. Frontend API Guide](./3.FRONTEND_API_GUIDE.md)
- [4. Stripe Integration](./4.STRIPE_INTEGRATION.md)
- [5. Testing Guide](./5.TESTING_GUIDE.md)
