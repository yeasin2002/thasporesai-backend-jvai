# 2. Backend Implementation Guide

**Version**: 2.0.0  
**Last Updated**: January 25, 2026  
**Status**: ‚úÖ Stripe Integration Complete (Phases 1-6)

---

## Overview

This guide covers the complete backend implementation of the JobSphere payment system with **full Stripe integration**, including database models, services, routes, webhook handling, and testing procedures.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Database Models](#database-models)
3. [Stripe Configuration](#stripe-configuration)
4. [Payment Configuration](#payment-configuration)
5. [Wallet Module](#wallet-module)
6. [Stripe Connect (Contractor Onboarding)](#stripe-connect-contractor-onboarding)
7. [Webhook Handling](#webhook-handling)
8. [Offer Module](#offer-module)
9. [Job Completion](#job-completion)
10. [Security & Rate Limiting](#security--rate-limiting)
11. [Testing Guide](#testing-guide)
12. [Error Handling](#error-handling)
13. [Troubleshooting](#troubleshooting)

---

## Architecture Overview

### Core Components

```
src/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ wallet/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit.service.ts          # Stripe Payment Intents
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdraw.service.ts         # Stripe Transfers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-connect-account.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-connect-account-status.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refresh-connect-account.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-withdrawal-status.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get-wallet.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wallet.route.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wallet.validation.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wallet.openapi.ts
‚îÇ   ‚îî‚îÄ‚îÄ webhooks/
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stripe-webhook.service.ts   # Webhook handler
‚îÇ       ‚îî‚îÄ‚îÄ webhook.route.ts
‚îú‚îÄ‚îÄ db/models/
‚îÇ   ‚îú‚îÄ‚îÄ user.model.ts                       # Stripe customer/account IDs
‚îÇ   ‚îú‚îÄ‚îÄ wallet.model.ts                     # Pending deposits
‚îÇ   ‚îî‚îÄ‚îÄ transaction.model.ts                # Stripe IDs, idempotency
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ stripe.ts                           # Stripe client initialization
‚îú‚îÄ‚îÄ jobs/
‚îÇ   ‚îî‚îÄ‚îÄ retry-failed-transactions.ts        # Auto-retry failed txns
‚îî‚îÄ‚îÄ middleware/
    ‚îî‚îÄ‚îÄ rate-limit.middleware.ts            # Rate limiting
```

### Payment Flow

```
Customer Deposit:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Frontend creates Payment Method (flutter_stripe)     ‚îÇ
‚îÇ  2. Backend creates Payment Intent (with confirmation)   ‚îÇ
‚îÇ  3. Stripe processes payment                             ‚îÇ
‚îÇ  4. Webhook receives payment_intent.succeeded            ‚îÇ
‚îÇ  5. Backend updates wallet balance                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Contractor Withdrawal:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Contractor has verified Connect account              ‚îÇ
‚îÇ  2. Backend creates Stripe Transfer                      ‚îÇ
‚îÇ  3. Wallet balance deducted atomically                   ‚îÇ
‚îÇ  4. Funds arrive in 1-2 business days                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Database Models

### User Model

**File**: `src/db/models/user.model.ts`

**Stripe Fields Added**:

```typescript
{
  // ... existing fields ...
  
  // Stripe Customer (for deposits)
  stripeCustomerId?: string;        // cus_xxx...
  
  // Stripe Connect (for contractors)
  stripeAccountId?: string;         // acct_xxx...
  stripeAccountStatus?: "pending" | "verified" | "rejected";
}

// Indexes (sparse for optional fields)
userSchema.index({ stripeCustomerId: 1 }, { sparse: true });
userSchema.index({ stripeAccountId: 1 }, { sparse: true });
```

### Wallet Model

**File**: `src/db/models/wallet.model.ts`

**Full Schema**:

```typescript
{
  user: ObjectId,                   // Reference to user
  balance: Number,                  // Available funds
  escrowBalance: Number,            // Funds held for offers
  pendingDeposits: Number,          // Deposits awaiting webhook
  currency: String,                 // "USD"
  isActive: Boolean,
  isFrozen: Boolean,
  totalEarnings: Number,            // Lifetime earnings
  totalSpent: Number,               // Lifetime spending
  totalWithdrawals: Number,         // Lifetime withdrawals
  lastStripeSync: Date              // Last Stripe sync timestamp
}
```

### Transaction Model

**File**: `src/db/models/transaction.model.ts`

**Full Schema with Stripe Fields**:

```typescript
{
  type: String,                     // Transaction type (enum)
  amount: Number,
  from: ObjectId,                   // Sender
  to: ObjectId,                     // Receiver
  offer?: ObjectId,                 // Related offer
  job?: ObjectId,                   // Related job
  status: "pending" | "completed" | "failed",
  description: String,
  
  // Stripe-specific fields
  stripePaymentIntentId?: String,   // pi_xxx...
  stripeTransferId?: String,        // tr_xxx...
  stripePayoutId?: String,          // po_xxx...
  stripeStatus?: String,            // Stripe status
  stripeError?: String,             // Error message
  
  // Idempotency & retry
  idempotencyKey?: String,          // UUID for safe retries
  retryCount: Number,               // Default: 0
  nextRetryAt?: Date,               // Next retry timestamp
  lastRetryAt?: Date,               // Last retry timestamp
  
  failureReason?: String,
  completedAt?: Date,
  createdAt: Date,
  updatedAt: Date
}

// Indexes
transactionSchema.index({ stripePaymentIntentId: 1 }, { sparse: true });
transactionSchema.index({ stripeTransferId: 1 }, { sparse: true });
transactionSchema.index({ idempotencyKey: 1 }, { sparse: true, unique: true });
transactionSchema.index({ type: 1, status: 1, createdAt: -1 });
```

**Transaction Types**:

| Type | Description | Flow |
|------|-------------|------|
| `deposit` | Wallet deposit via Stripe | Customer ‚Üí Wallet |
| `withdrawal` | Withdrawal via Stripe Transfer | Wallet ‚Üí Bank |
| `escrow_hold` | Money held for offer | Wallet ‚Üí Escrow |
| `escrow_release` | Money released from escrow | Escrow ‚Üí Wallet |
| `platform_fee` | 5% fee on offer accept | Escrow ‚Üí Admin |
| `service_fee` | 20% fee on job complete | Escrow ‚Üí Admin |
| `contractor_payout` | 80% to contractor | Escrow ‚Üí Contractor |
| `refund` | Refund on reject/cancel | Escrow ‚Üí Customer |

---

## Stripe Configuration

### Environment Variables

**Required in `.env`**:

```env
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### Stripe Client Initialization

**File**: `src/lib/stripe.ts`

```typescript
import Stripe from 'stripe';
import { Env } from './Env';

const STRIPE_SECRET_KEY = Env.STRIPE_SECRET_KEY;

if (!STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY is required');
}

// @ts-expect-error - Using stable API version
export const stripe = new Stripe(STRIPE_SECRET_KEY, {
  apiVersion: '2024-12-18.acacia',  // Stable version
  typescript: true,
  appInfo: {
    name: 'JobSphere',
    version: '1.0.0',
  },
});

export const STRIPE_PUBLISHABLE_KEY = Env.STRIPE_PUBLISHABLE_KEY;
```

### Webhook Registration

**File**: `src/app.ts`

> ‚ö†Ô∏è **CRITICAL**: Webhook route must be registered BEFORE `express.json()` middleware!

```typescript
import { webhook } from '@/api/webhooks/webhook.route';

// Register webhook BEFORE body parser (requires raw body)
app.use('/api/webhooks', webhook);

// Then register body parser for other routes
app.use(express.json());
```

---

## Payment Configuration

**File**: `src/common/payment-config.ts`

```typescript
export const PAYMENT_CONFIG = {
  PLATFORM_FEE_PERCENT: 5,        // Charged to customer
  SERVICE_FEE_PERCENT: 20,        // Deducted from contractor
  BUYER_TOTAL_PERCENT: 105,       // Customer pays 105%
  CONTRACTOR_PAYOUT_PERCENT: 80,  // Contractor gets 80%
  ADMIN_TOTAL_PERCENT: 25,        // Admin gets 25% total
  CURRENCY: 'USD',
  MIN_JOB_BUDGET: 10,
  MAX_JOB_BUDGET: 10000,
  MIN_DEPOSIT: 10,
  MAX_WITHDRAWAL: 10000,
  OFFER_EXPIRY_DAYS: 7,
};

export const calculatePaymentAmounts = (jobBudget: number) => {
  const platformFee = jobBudget * 0.05;
  const serviceFee = jobBudget * 0.20;
  const contractorPayout = jobBudget - serviceFee;
  const totalCharge = jobBudget + platformFee;
  const adminTotal = platformFee + serviceFee;

  return {
    jobBudget,
    platformFee,
    serviceFee,
    contractorPayout,
    totalCharge,
    adminTotal,
  };
};
```

---

## Wallet Module

### Deposit Service

**File**: `src/api/wallet/services/deposit.service.ts`

**Flow**:

1. Validate minimum amount ($10)
2. Check for duplicate request (idempotency)
3. Get or create Stripe Customer
4. Create Payment Intent with automatic confirmation
5. Handle 3D Secure if required
6. Create pending transaction record
7. Update wallet `pendingDeposits`
8. Return client secret for frontend

**Implementation Highlights**:

```typescript
export const deposit: RequestHandler = async (req, res) => {
  const { amount, paymentMethodId } = req.body;
  const userId = req.user!._id;
  
  // Generate idempotency key
  const idempotencyKey = randomUUID();
  
  // Check for duplicate request
  const existingTransaction = await db.transaction.findOne({ idempotencyKey });
  if (existingTransaction) {
    return sendSuccess(res, 200, 'Deposit already processed', {
      transaction: existingTransaction,
    });
  }
  
  // Get or create Stripe customer
  const user = await db.user.findById(userId);
  let stripeCustomerId = user.stripeCustomerId;
  
  if (!stripeCustomerId) {
    const customer = await stripe.customers.create({
      email: user.email,
      name: user.full_name,
      metadata: { userId: userId.toString() },
    });
    stripeCustomerId = customer.id;
    user.stripeCustomerId = stripeCustomerId;
    await user.save();
  }
  
  // Create Payment Intent
  const paymentIntent = await stripe.paymentIntents.create({
    amount: Math.round(amount * 100),  // Convert to cents
    currency: 'usd',
    customer: stripeCustomerId,
    payment_method: paymentMethodId,
    confirm: true,
    automatic_payment_methods: {
      enabled: true,
      allow_redirects: 'never',
    },
    metadata: {
      userId: userId.toString(),
      walletId: wallet._id.toString(),
      type: 'deposit',
      idempotencyKey,
    },
  }, {
    idempotencyKey,  // Stripe-level idempotency
  });
  
  // Handle different payment states
  if (paymentIntent.status === 'requires_action') {
    return sendSuccess(res, 200, 'Additional authentication required', {
      requiresAction: true,
      clientSecret: paymentIntent.client_secret,
      paymentIntentId: paymentIntent.id,
    });
  }
  
  // Create pending transaction (webhook will complete it)
  await db.transaction.create({
    type: 'deposit',
    amount,
    from: userId,
    to: userId,
    status: 'pending',
    stripePaymentIntentId: paymentIntent.id,
    idempotencyKey,
    description: `Wallet deposit of $${amount}`,
  });
  
  // Update pending deposits
  wallet.pendingDeposits = (wallet.pendingDeposits || 0) + amount;
  await wallet.save();
  
  return sendSuccess(res, 200, 'Payment initiated successfully', {
    paymentIntent: {
      id: paymentIntent.id,
      status: paymentIntent.status,
      amount,
      clientSecret: paymentIntent.client_secret,
    },
    wallet: {
      balance: wallet.balance,
      pendingDeposits: wallet.pendingDeposits,
    },
  });
};
```

### Withdraw Service

**File**: `src/api/wallet/services/withdraw.service.ts`

**Flow**:

1. Verify user is contractor
2. Check Stripe Connect account is verified
3. Validate withdrawal amount
4. Create Stripe Transfer to connected account
5. Atomically deduct wallet balance
6. If wallet update fails, reverse transfer
7. Create transaction record

**Implementation Highlights**:

```typescript
export const withdraw: RequestHandler = async (req, res) => {
  const { amount } = req.body;
  const userId = req.user!._id;
  
  // Verify contractor and account status
  const user = await db.user.findById(userId);
  
  if (!user.stripeAccountId) {
    return sendBadRequest(res, 'Please complete Stripe Connect onboarding');
  }
  
  if (user.stripeAccountStatus !== 'verified') {
    return sendBadRequest(res, `Account is ${user.stripeAccountStatus}`);
  }
  
  // Verify account is fully activated
  const account = await stripe.accounts.retrieve(user.stripeAccountId);
  if (!account.charges_enabled || !account.payouts_enabled) {
    return sendBadRequest(res, 'Account not fully activated');
  }
  
  // Generate idempotency key
  const idempotencyKey = randomUUID();
  
  // Create Stripe Transfer FIRST
  const transfer = await stripe.transfers.create({
    amount: Math.round(amount * 100),
    currency: 'usd',
    destination: user.stripeAccountId,
    metadata: {
      userId: userId.toString(),
      type: 'withdrawal',
      idempotencyKey,
    },
  }, {
    idempotencyKey,
  });
  
  // Atomically update wallet (race condition prevention)
  const wallet = await db.wallet.findOneAndUpdate(
    {
      user: userId,
      balance: { $gte: amount },  // Atomic check
      isFrozen: false,
    },
    {
      $inc: {
        balance: -amount,
        totalWithdrawals: amount,
      },
    },
    { new: true }
  );
  
  // ROLLBACK if wallet update failed
  if (!wallet) {
    try {
      await stripe.transfers.createReversal(transfer.id);
      console.log(`‚úÖ Transfer ${transfer.id} reversed`);
    } catch (reversalError) {
      console.error('‚ùå Failed to reverse transfer:', reversalError);
    }
    return sendBadRequest(res, 'Insufficient balance');
  }
  
  // Create transaction record
  await db.transaction.create({
    type: 'withdrawal',
    amount,
    from: userId,
    to: userId,
    status: 'pending',
    stripeTransferId: transfer.id,
    idempotencyKey,
    description: `Withdrawal of $${amount}`,
    completedAt: new Date(),
  });
  
  return sendSuccess(res, 200, 'Withdrawal initiated successfully', {
    transfer: {
      id: transfer.id,
      amount,
      status: 'pending',
    },
    wallet: {
      balance: wallet.balance,
      totalWithdrawals: wallet.totalWithdrawals,
    },
    estimatedArrival: '1-2 business days',
  });
};
```

---

## Stripe Connect (Contractor Onboarding)

### Create Connect Account

**File**: `src/api/wallet/services/create-connect-account.service.ts`

```typescript
export const createConnectAccount: RequestHandler = async (req, res) => {
  const userId = req.user!._id;
  const user = await db.user.findById(userId);
  
  // Check if account already exists
  if (user.stripeAccountId) {
    return sendBadRequest(res, 'Connect account already exists');
  }
  
  // Create Express account
  const account = await stripe.accounts.create({
    type: 'express',
    country: 'US',
    email: user.email,
    capabilities: {
      transfers: { requested: true },
    },
    business_type: 'individual',
    metadata: {
      userId: userId.toString(),
      userEmail: user.email,
    },
  });
  
  // Save account ID
  user.stripeAccountId = account.id;
  user.stripeAccountStatus = 'pending';
  await user.save();
  
  // Generate onboarding link
  const accountLink = await stripe.accountLinks.create({
    account: account.id,
    refresh_url: `${API_BASE_URL}/api/wallet/connect-account/refresh`,
    return_url: `${API_BASE_URL}/api/wallet/connect-account/return`,
    type: 'account_onboarding',
  });
  
  return sendSuccess(res, 201, 'Stripe Connect account created', {
    accountId: account.id,
    onboardingUrl: accountLink.url,
    expiresAt: new Date(accountLink.expires_at * 1000),
  });
};
```

### Get Account Status

**File**: `src/api/wallet/services/get-connect-account-status.service.ts`

```typescript
export const getConnectAccountStatus: RequestHandler = async (req, res) => {
  const user = await db.user.findById(req.user!._id);
  
  if (!user.stripeAccountId) {
    return sendSuccess(res, 200, 'No Connect account', { hasAccount: false });
  }
  
  const account = await stripe.accounts.retrieve(user.stripeAccountId);
  
  // Determine account status
  let accountStatus: 'pending' | 'verified' | 'rejected' = 'pending';
  
  if (account.details_submitted && account.charges_enabled) {
    accountStatus = 'verified';
  }
  
  // Check for rejection
  const rejectionReasons = [
    'rejected.fraud',
    'rejected.terms_of_service',
    'rejected.listed',
    'rejected.other',
  ];
  
  if (rejectionReasons.includes(account.requirements?.disabled_reason || '')) {
    accountStatus = 'rejected';
  }
  
  // Sync status to database
  if (user.stripeAccountStatus !== accountStatus) {
    user.stripeAccountStatus = accountStatus;
    await user.save();
  }
  
  return sendSuccess(res, 200, 'Account status retrieved', {
    hasAccount: true,
    accountId: account.id,
    status: accountStatus,
    onboardingComplete: account.details_submitted && account.charges_enabled,
    chargesEnabled: account.charges_enabled,
    payoutsEnabled: account.payouts_enabled,
    requirements: {
      currentlyDue: account.requirements?.currently_due || [],
      pendingVerification: account.requirements?.pending_verification || [],
      errors: account.requirements?.errors || [],
    },
    capabilities: {
      transfers: account.capabilities?.transfers,
    },
  });
};
```

---

## Webhook Handling

**File**: `src/api/webhooks/services/stripe-webhook.service.ts`

### Webhook Route Setup

**File**: `src/api/webhooks/webhook.route.ts`

```typescript
import express from 'express';
import { handleStripeWebhook } from './services/stripe-webhook.service';

export const webhook = express.Router();

// Use raw body for signature verification
webhook.post(
  '/stripe',
  express.raw({ type: 'application/json' }),
  handleStripeWebhook
);
```

### Webhook Handler Implementation

```typescript
export const handleStripeWebhook: RequestHandler = async (req, res) => {
  const sig = req.headers['stripe-signature'];
  
  if (!sig) {
    return res.status(400).send('No signature found');
  }
  
  let event: Stripe.Event;
  
  try {
    event = stripe.webhooks.constructEvent(
      req.body,
      sig,
      STRIPE_WEBHOOK_SECRET
    );
  } catch (err) {
    console.error('‚ùå Webhook signature verification failed');
    return res.status(400).send('Invalid signature');
  }
  
  console.log(`‚úÖ Received webhook: ${event.type}`);
  
  try {
    switch (event.type) {
      case 'payment_intent.succeeded':
        await handlePaymentIntentSucceeded(
          event.data.object as Stripe.PaymentIntent
        );
        break;
        
      case 'payment_intent.payment_failed':
        await handlePaymentIntentFailed(
          event.data.object as Stripe.PaymentIntent
        );
        break;
        
      case 'payment_intent.canceled':
        await handlePaymentIntentCanceled(
          event.data.object as Stripe.PaymentIntent
        );
        break;
        
      case 'account.updated':
        await handleAccountUpdated(
          event.data.object as Stripe.Account
        );
        break;
        
      case 'transfer.reversed':
        await handleTransferReversed(
          event.data.object as Stripe.Transfer
        );
        break;
        
      default:
        console.log(`‚ö†Ô∏è Unhandled event type: ${event.type}`);
    }
  } catch (error) {
    console.error(`‚ùå Error processing ${event.type}:`, error);
    return res.status(500).json({ error: 'Webhook processing failed' });
  }
  
  res.json({ received: true });
};
```

### Payment Intent Handlers

```typescript
async function handlePaymentIntentSucceeded(
  paymentIntent: Stripe.PaymentIntent
) {
  const { userId, walletId } = paymentIntent.metadata;
  const amount = paymentIntent.amount / 100;  // Convert from cents
  
  console.log(`üí∞ Processing successful payment: ${paymentIntent.id}`);
  
  // Find pending transaction
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
    status: 'pending',
  });
  
  if (!transaction) {
    console.log(`‚ö†Ô∏è Transaction not found for ${paymentIntent.id}`);
    return;
  }
  
  // Update wallet balance
  const wallet = await db.wallet.findById(walletId);
  wallet.balance += amount;
  wallet.pendingDeposits = Math.max(0, (wallet.pendingDeposits || 0) - amount);
  wallet.lastStripeSync = new Date();
  await wallet.save();
  
  // Complete transaction
  transaction.status = 'completed';
  transaction.stripeStatus = paymentIntent.status;
  transaction.completedAt = new Date();
  await transaction.save();
  
  console.log(`‚úÖ Deposit completed: $${amount} added to wallet ${walletId}`);
}

async function handlePaymentIntentFailed(paymentIntent: Stripe.PaymentIntent) {
  const amount = paymentIntent.amount / 100;
  const { walletId } = paymentIntent.metadata;
  
  console.log(`‚ùå Processing failed payment: ${paymentIntent.id}`);
  
  // Update transaction
  const transaction = await db.transaction.findOne({
    stripePaymentIntentId: paymentIntent.id,
  });
  
  if (transaction) {
    transaction.status = 'failed';
    transaction.stripeStatus = paymentIntent.status;
    transaction.stripeError = paymentIntent.last_payment_error?.message;
    transaction.failureReason = paymentIntent.last_payment_error?.message;
    await transaction.save();
  }
  
  // Update pending deposits
  const wallet = await db.wallet.findById(walletId);
  if (wallet) {
    wallet.pendingDeposits = Math.max(0, (wallet.pendingDeposits || 0) - amount);
    await wallet.save();
  }
  
  console.log(`‚ùå Deposit failed: $${amount} for wallet ${walletId}`);
}

async function handleAccountUpdated(account: Stripe.Account) {
  const userId = account.metadata?.userId;
  
  if (!userId) return;
  
  console.log(`üè¶ Account updated: ${account.id}`);
  
  const user = await db.user.findById(userId);
  if (!user) return;
  
  // Determine status
  let status: 'pending' | 'verified' | 'rejected' = 'pending';
  
  if (account.details_submitted && account.charges_enabled) {
    status = 'verified';
  }
  
  const rejectionReasons = [
    'rejected.fraud',
    'rejected.terms_of_service',
    'rejected.listed',
    'rejected.other',
  ];
  
  if (rejectionReasons.includes(account.requirements?.disabled_reason || '')) {
    status = 'rejected';
  }
  
  user.stripeAccountStatus = status;
  await user.save();
  
  console.log(`‚úÖ Account ${account.id} status: ${status}`);
}
```

---

## Offer Module

### Send Offer

**File**: `src/api/job-request/services/send-offer.service.ts`

**Flow**:

1. Validate application exists
2. Verify customer owns the job
3. Check job status is "open"
4. Check no existing offer for this job
5. Calculate payment amounts
6. Check wallet balance sufficient
7. Create offer record
8. Deduct from wallet ‚Üí escrow
9. Create escrow_hold transaction
10. Send notification to contractor

---

## Job Completion

### Complete Job

**File**: `src/api/job/services/complete-job.service.ts`

**Money Movement on Completion**:

```
Before Complete:
‚îú‚îÄ‚îÄ Customer escrow: $100
‚îú‚îÄ‚îÄ Admin balance: $5 (platform fee from accept)
‚îî‚îÄ‚îÄ Contractor balance: $0

After Complete:
‚îú‚îÄ‚îÄ Customer escrow: $0
‚îú‚îÄ‚îÄ Admin balance: $25 (+$20 service fee)
‚îî‚îÄ‚îÄ Contractor balance: $80 (payout)
```

---

## Security & Rate Limiting

### Rate Limiting

**File**: `src/middleware/rate-limit.middleware.ts`

```typescript
import rateLimit from 'express-rate-limit';

export const depositRateLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,  // 1 hour
  max: 5,
  message: 'Too many deposit attempts. Try again in 1 hour.',
});

export const withdrawRateLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 3,
  message: 'Too many withdrawal attempts. Try again in 1 hour.',
});

export const connectAccountRateLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 2,
  message: 'Too many account creation attempts.',
});
```

### Apply Rate Limiting

**File**: `src/api/wallet/wallet.route.ts`

```typescript
wallet.post(
  '/deposit',
  requireAuth,
  depositRateLimiter,
  validate(DepositSchema),
  deposit
);

wallet.post(
  '/withdraw',
  requireAuth,
  requireRole('contractor'),
  withdrawRateLimiter,
  validate(WithdrawSchema),
  withdraw
);
```

### Idempotency Implementation

- All deposit/withdrawal requests generate a UUID idempotency key
- Key is stored in transaction record and sent to Stripe
- Duplicate requests return the existing transaction
- Prevents double-charging on network retries

---

## Testing Guide

### Prerequisites

1. **Install Stripe CLI**:
   ```bash
   # Windows (PowerShell)
   scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git
   scoop install stripe
   
   # macOS
   brew install stripe/stripe-cli/stripe
   ```

2. **Login to Stripe**:
   ```bash
   stripe login
   ```

3. **Get API Keys** from [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys)

4. **Configure `.env`**:
   ```env
   STRIPE_SECRET_KEY=sk_test_...
   STRIPE_PUBLISHABLE_KEY=pk_test_...
   STRIPE_WEBHOOK_SECRET=whsec_...
   ```

### Start Webhook Forwarding

```bash
# In a separate terminal (keep running during testing)
stripe listen --forward-to localhost:4000/api/webhooks/stripe
```

Copy the `whsec_...` secret and update `.env`.

### Test Cards

| Card Number | Result |
|-------------|--------|
| `4242 4242 4242 4242` | ‚úÖ Success |
| `4000 0000 0000 0002` | ‚ùå Declined (insufficient funds) |
| `4000 0000 0000 0341` | ‚ùå Declined (generic) |
| `4000 0000 0000 9995` | ‚ùå Declined (insufficient funds) |
| `4000 0000 0000 0069` | ‚ùå Expired card |
| `4000 0000 0000 0127` | ‚ùå Incorrect CVC |
| `4000 0027 6000 3184` | üîê Requires 3D Secure |

**Expiry**: Any future date (e.g., `12/30`)  
**CVC**: Any 3 digits (e.g., `123`)

### Testing Deposit Flow

1. **Create payment method**:
   ```bash
   stripe payment_methods create \
     --type=card \
     --card[number]=4242424242424242 \
     --card[exp_month]=12 \
     --card[exp_year]=2030 \
     --card[cvc]=123
   ```

2. **Make deposit request**:
   ```bash
   curl -X POST http://localhost:4000/api/wallet/deposit \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{"amount":100,"paymentMethodId":"pm_xxx..."}'
   ```

3. **Check webhook terminal** - should see:
   ```
   ‚úÖ Received webhook: payment_intent.succeeded
   üí∞ Processing successful payment: pi_xxx...
   ‚úÖ Deposit completed: $100 added to wallet
   ```

4. **Verify wallet balance**:
   ```bash
   curl http://localhost:4000/api/wallet \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

### Testing Webhook Events Manually

```bash
# Trigger payment success
stripe trigger payment_intent.succeeded

# Trigger payment failure
stripe trigger payment_intent.payment_failed

# Trigger account update
stripe trigger account.updated
```

### Running Unit Tests

```bash
# Run all tests
bun test

# Run with coverage
bun test:coverage

# Run in watch mode
bun test:watch
```

### Verification Checklist

- ‚úÖ Successful deposits update wallet balance
- ‚úÖ Failed payments don't update balance
- ‚úÖ Pending deposits decrease after webhook
- ‚úÖ Transaction records created correctly
- ‚úÖ Stripe customer ID saved to user
- ‚úÖ Webhook signature verification working
- ‚úÖ Rate limiting enforced
- ‚úÖ Idempotency prevents duplicates
- ‚úÖ Connect onboarding flow works
- ‚úÖ Withdrawals transfer to connected account
- ‚úÖ Transfer reversal on wallet update failure

---

## Error Handling

### Stripe Error Types

```typescript
try {
  const paymentIntent = await stripe.paymentIntents.create({...});
} catch (error) {
  if (error instanceof Stripe.errors.StripeCardError) {
    // Card errors (declined, insufficient funds, etc.)
    return sendBadRequest(res, error.message);
  }
  
  if (error instanceof Stripe.errors.StripeInvalidRequestError) {
    // Invalid parameters
    console.error('Invalid request:', error.message);
    return sendBadRequest(res, 'Invalid payment request');
  }
  
  if (error instanceof Stripe.errors.StripeAPIError) {
    // Stripe API error (retryable)
    console.error('Stripe API error:', error.message);
    return sendInternalError(res, 'Payment service unavailable');
  }
  
  throw error;
}
```

### Common Error Messages

| Error | User Message |
|-------|--------------|
| `card_declined` | "Your card was declined" |
| `insufficient_funds` | "Your card has insufficient funds" |
| `expired_card` | "Your card has expired" |
| `incorrect_cvc` | "Your card's security code is incorrect" |
| `processing_error` | "An error occurred. Please try again" |

---

## Troubleshooting

### "No signature found"

**Cause**: Webhook route not receiving raw body

**Solution**: Ensure webhook route is registered BEFORE `express.json()` in `app.ts`

### "Webhook signature verification failed"

**Cause**: Incorrect webhook secret

**Solution**: 
1. Run `stripe listen --forward-to localhost:4000/api/webhooks/stripe`
2. Copy the `whsec_...` secret
3. Update `STRIPE_WEBHOOK_SECRET` in `.env`
4. Restart server

### "Payment Intent creation failed"

**Cause**: Invalid API key

**Solution**: Verify `STRIPE_SECRET_KEY` starts with `sk_test_`

### "Transfer failed - Account not verified"

**Cause**: Contractor hasn't completed onboarding

**Solution**: 
1. Check `/api/wallet/connect-account/status`
2. Complete onboarding via the onboarding URL
3. Wait for `account.updated` webhook

### Checking Stripe Dashboard

- **Payments**: https://dashboard.stripe.com/test/payments
- **Webhooks**: https://dashboard.stripe.com/test/webhooks
- **Connect Accounts**: https://dashboard.stripe.com/test/connect/accounts
- **Logs**: https://dashboard.stripe.com/test/logs

### Database Queries

```javascript
// Find pending deposits
db.transaction.find({ type: "deposit", status: "pending" })

// Find failed transactions
db.transaction.find({ status: "failed" })

// Check user's Stripe IDs
db.user.findOne({ email: "user@example.com" }, { stripeCustomerId: 1, stripeAccountId: 1 })

// Check wallet balance
db.wallet.findOne({ user: ObjectId("...") })
```

---

## Summary

### Key Implementation Points

1. **Webhook First**: Register webhook before body parser
2. **Idempotency**: Use UUIDs to prevent duplicate charges
3. **Atomic Operations**: Use findOneAndUpdate with conditions
4. **Rollback**: Reverse Stripe transfers on wallet update failure
5. **Audit Trail**: Create transaction records for everything
6. **Rate Limiting**: Protect sensitive endpoints
7. **Error Handling**: Return user-friendly Stripe error messages

### Files Reference

| File | Purpose |
|------|---------|
| `src/lib/stripe.ts` | Stripe client initialization |
| `src/api/wallet/services/deposit.service.ts` | Payment Intent creation |
| `src/api/wallet/services/withdraw.service.ts` | Transfer to connected account |
| `src/api/webhooks/services/stripe-webhook.service.ts` | Webhook handler |
| `src/middleware/rate-limit.middleware.ts` | Rate limiting |
| `src/jobs/retry-failed-transactions.ts` | Auto-retry logic |

---

**Related Documentation**:

- [1. MAIN-REFERENCE](./1.MAIN-REFERENCE.md) - Complete system overview
- [3. Frontend API Guide](./3.FRONTEND_API_GUIDE.md) - Flutter integration guide
- [Phase Completion Docs](./PHASE_COMPLETE_DOC/) - Detailed phase summaries
- [STRIPE_TESTING_GUIDE](./PHASE_COMPLETE_DOC/STRIPE_TESTING_GUIDE.md) - Testing instructions
