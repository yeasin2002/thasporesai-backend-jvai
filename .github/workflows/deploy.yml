name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/thasporesai-backend-jvai
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ğŸ›‘ Stopping containers..."
            docker compose down
            
            echo "ğŸ”¨ Building and starting containers..."
            docker compose up -d --build
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "â³ Waiting for application to start..."
            sleep 15
            
            echo "ğŸ” Health check..."
            if curl -s http://localhost:4000/ > /dev/null; then
              echo "âœ… Deployment complete! Application is running."
            else
              echo "âš ï¸ Health check failed - checking logs..."
              docker compose logs --tail=50 jobsphere-app
            fi
            
            echo ""
            echo "ğŸ“Š Container status:"
            docker ps --filter name=jobsphere-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
