name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/thasporesai-backend-jvai
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ï¿½ Installing Task (if not installed)..."
            if ! command -v task &> /dev/null; then
              sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
            fi
            
            echo "ğŸ” Verifying Task installation..."
            task --version
            
            echo "ğŸš€ Running deployment..."
            task update
            
            echo ""
            echo "ï¿½ Deployment Summary:"
            task docker:ps
            
            echo ""
            echo "ğŸ§ª Running health checks..."
            task test:all || echo "âš ï¸ Some health checks failed - check logs with: task docker:logs"
